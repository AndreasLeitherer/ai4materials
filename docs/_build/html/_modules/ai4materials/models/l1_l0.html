

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ai4materials.models.l1_l0 &mdash; ai4materials v0.1.0</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="ai4materials v0.1.0" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/>
    <link href="../../../_static/nomad-analytics.css" rel="stylesheet" type="text/css">


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ai4materials
          

          
            
            <img src="../../../_static/ai_for_materials_logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.dataprocessing.html">Data preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.descriptors.html">Representing crystal structures: descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.wrappers.html">Creating and loading materials science datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.models.html">Regression and classification models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.interpretation.html">Neural network interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ai4materials</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ai4materials.models.l1_l0</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ai4materials.models.l1_l0</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding=utf-8</span>
<span class="c1"># Copyright 2016-2018 Angelo Ziletti</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Angelo Ziletti&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2018, Angelo Ziletti&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Angelo Ziletti&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;ziletti@fhi-berlin.mpg.de&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;23/09/18&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">linear_model</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">nomadcore.unit_conversion.unit_conversion</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ai4materials&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="choose_atomic_features"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.choose_atomic_features">[docs]</a><span class="k">def</span> <span class="nf">choose_atomic_features</span><span class="p">(</span><span class="n">selected_feature_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">atomic_data_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary_data_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Choose primary features for the extended lasso procedure.&quot;&quot;&quot;</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">atomic_data_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">binary_data_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># merge two dataframes on Material</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Mat&#39;</span><span class="p">)</span>

    <span class="c1"># calculate r_sigma and r_pi [Phys. Rev. Lett. 33, 1095(1974)]</span>
    <span class="n">radii_s_p</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rp(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;rs(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;rp(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;rs(B)&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;r_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">radii_s_p</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r_sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;r_pi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">radii_s_p</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r_pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculate Es/sqrt(Zval) and Ep/sqrt(Zval)</span>
    <span class="n">e_val_z</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Es(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;val(A)&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Es(A)/sqrt(Zval(A))&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">e_val_z</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e_sqrt_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">e_val_z</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Es(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;val(B)&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Es(B)/sqrt(Zval(B))&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">e_val_z</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e_sqrt_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">e_val_z</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ep(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;val(A)&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Ep(A)/sqrt(Zval(A))&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">e_val_z</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e_sqrt_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">e_val_z</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ep(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;val(B)&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Ep(B)/sqrt(Zval(B))&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">e_val_z</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e_sqrt_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">column_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">feature_list</span> <span class="o">=</span> <span class="n">column_list</span>

    <span class="k">if</span> <span class="s1">&#39;Mat&#39;</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="n">feature_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Mat&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;Edim&#39;</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="n">feature_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Edim&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Available features: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_list</span><span class="p">))</span>

    <span class="n">df_selected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">selected_feature_list</span><span class="p">]</span>
    <span class="n">df_selected</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Mat&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mat&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">selected_feature_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Primary features selected: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_feature_list</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No selected features.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_selected</span></div>


<div class="viewcode-block" id="classify_rs_zb"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.classify_rs_zb">[docs]</a><span class="k">def</span> <span class="nf">classify_rs_zb</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classify if a structure is rocksalt of zincblend from a list of NoMaD structure.</span>
<span class="sd">    (one json file). Supports multiple frames (TO DO: check that). Hard-coded.</span>

<span class="sd">    rocksalt:</span>
<span class="sd">    atom_frac1 0.0 0.0 0.0</span>
<span class="sd">    atom_frac2 0.5 0.5 0.5</span>

<span class="sd">    zincblende:</span>
<span class="sd">    atom_frac1 0.0  0.0  0.0</span>
<span class="sd">    atom_frac2 0.25 0.25 0.25</span>

<span class="sd">    zincblende --&gt; label=0</span>
<span class="sd">    rocksalt  --&gt; label=1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">chemical_formula</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># gIndexRun=0</span>
    <span class="c1"># gIndexDesc=1</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">),</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">energy_eV</span><span class="p">[(</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">)]</span>
            <span class="c1"># energy=1.0</span>
            <span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">chemical_formula</span><span class="p">[(</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">)]</span>
            <span class="c1"># get labels, works only for RS/ZB dataset</span>
            <span class="n">pos_atom_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">scaled_positions</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mf">0.375</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pos_atom_2</span><span class="p">):</span>
                <span class="c1"># label=&#39;zincblend&#39;</span>
                <span class="n">label</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># label=&#39;rocksalt&#39;</span>
                <span class="n">label</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">break</span>

    <span class="k">return</span> <span class="n">chemical_formula</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">label</span></div>


<div class="viewcode-block" id="get_energy_diff"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.get_energy_diff">[docs]</a><span class="k">def</span> <span class="nf">get_energy_diff</span><span class="p">(</span><span class="n">chemical_formula_list</span><span class="p">,</span> <span class="n">energy_list</span><span class="p">,</span> <span class="n">label_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Obtain difference in energy (eV) between rocksalt and zincblend structures of a given binary.</span>

<span class="sd">    From a list of chemical formulas, energies and labels returns a dictionary</span>
<span class="sd">    with {`material`: `delta_e`} where `delta_e` is the difference between the energy</span>
<span class="sd">    with label 1 and energy with label 0, grouped by material.</span>
<span class="sd">    Each element of such list corresponds to a json file.</span>
<span class="sd">    The `delta_e` is exactly what reported in the PRL 114, 105503(2015).</span>


<span class="sd">    .. todo:: Check if it works for multiple frames.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chemical_formula_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label_</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># energy and chemical formula are lists even if only one frame is present</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">energy_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">energy_list</span><span class="p">):</span>
        <span class="n">energy_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy_i</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chemical_formula_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chemical_formula_list</span><span class="p">):</span>
        <span class="n">chemical_formula_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chemical_formula_i</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_list</span><span class="p">):</span>
        <span class="n">label_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_i</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># flatten the lists</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">energy_</span><span class="p">))</span>
    <span class="n">chemical_formula</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">chemical_formula_</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">label_</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemical_formula</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

    <span class="c1"># generate summary dataframe with lowest zincblend and rocksalt energy</span>
    <span class="c1"># zincblend --&gt; label=0</span>
    <span class="c1"># rocksalt  --&gt; label=1</span>
    <span class="n">df_summary</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Energy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Mat&#39;</span><span class="p">,</span> <span class="s1">&#39;Label&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">groupby_mat</span> <span class="o">=</span> <span class="n">df_summary</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Mat&#39;</span><span class="p">)</span>

    <span class="n">dict_delta_e</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">groupby_mat</span><span class="p">:</span>
        <span class="c1"># calculate the delta_e (E_RS - E_ZB)</span>
        <span class="n">energy_label_1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Energy</span><span class="o">.</span><span class="n">values</span>
        <span class="n">energy_label_0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Energy</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># if energy_diff&gt;0 --&gt; rs</span>
        <span class="c1"># if energy_diff&lt;0 --&gt; zb</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">energy_label_0</span> <span class="ow">and</span> <span class="n">energy_label_1</span><span class="p">):</span>
            <span class="c1"># single element numpy array --&gt; convert to scalar</span>
            <span class="n">energy_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">energy_label_1</span> <span class="o">-</span> <span class="n">energy_label_0</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># divide by 2 because it is the energy_diff for each atom</span>
            <span class="n">energy_diff</span> <span class="o">=</span> <span class="n">energy_diff</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Could not find all the energies needed to calculate required property for material &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dict_delta_e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mat</span><span class="p">:</span> <span class="p">(</span><span class="n">energy_diff</span><span class="p">,</span> <span class="n">energy_label_0</span><span class="p">,</span> <span class="n">energy_label_1</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">dict_delta_e</span></div>


<div class="viewcode-block" id="get_lowest_energy_structures"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.get_lowest_energy_structures">[docs]</a><span class="k">def</span> <span class="nf">get_lowest_energy_structures</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">dict_delta_e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get lowest energy structure for each material and label type.</span>

<span class="sd">    Works only with two possible labels for a given material.</span>

<span class="sd">    .. todo:: Check if it works for multiple frames.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">chemical_formula</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">is_lowest_energy</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">),</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">energy_eV</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>
            <span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>

            <span class="n">lowest_energy_label_0</span> <span class="o">=</span> <span class="n">dict_delta_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lowest_energy_label_1</span> <span class="o">=</span> <span class="n">dict_delta_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lowest_energy_label_0</span> <span class="o">&gt;</span> <span class="n">lowest_energy_label_1</span><span class="p">:</span>
                <span class="n">lowest_energy_label_01</span> <span class="o">=</span> <span class="n">lowest_energy_label_1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lowest_energy_label_01</span> <span class="o">=</span> <span class="n">lowest_energy_label_0</span>

            <span class="k">if</span> <span class="n">energy</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">==</span> <span class="n">lowest_energy_label_01</span><span class="p">:</span>
                <span class="n">is_lowest_energy</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_lowest_energy</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">is_lowest_energy</span></div>


<div class="viewcode-block" id="write_atomic_features"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.write_atomic_features">[docs]</a><span class="k">def</span> <span class="nf">write_atomic_features</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">selected_feature_list</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dict_delta_e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename_suffix</span><span class="o">=</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="n">json_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given the chemical composition, build the descriptor made of atomic features only.</span>

<span class="sd">    Includes all the frames in the same json file.</span>

<span class="sd">    .. todo:: Check if it works for multiple frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make dictionary {primary_feature: value} for each structure</span>
    <span class="c1"># dictionary of a dictionary, key: Mat, value: atomic_features</span>
    <span class="n">dict_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;chemical_formula&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># label=0: rocksalt, label=1: zincblend</span>
    <span class="c1">#chemical_formula_, energy_, label_ = classify_rs_zb(structure)</span>

    <span class="c1">#is_lowest_energy_ = get_lowest_energy_structures(structure, dict_delta_e)</span>

    <span class="k">if</span> <span class="n">structure</span><span class="o">.</span><span class="n">isPeriodic</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">),</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># filename is the normalized absolute path</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                                         <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">filename_suffix</span><span class="p">))))</span>

                <span class="n">outF</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">outF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">              &quot;data&quot;:[&quot;&quot;&quot;</span><span class="p">)</span>

                <span class="n">cell</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>
                <span class="n">chemical_formula</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">chemical_formula_</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">energy_eV</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label_</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]</span>
                <span class="c1">#target = dict_delta_e.get(chemical_formula_[gIndexRun, gIndexDesc])[0]</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">dict_delta_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chemical_formula</span><span class="p">)</span>

                <span class="n">atomic_features</span> <span class="o">=</span> <span class="n">dict_features</span><span class="p">[</span><span class="n">structure</span><span class="o">.</span><span class="n">chemical_formula</span><span class="p">[</span><span class="n">gIndexRun</span><span class="p">,</span> <span class="n">gIndexDesc</span><span class="p">]]</span>
                <span class="c1">#is_lowest_energy = is_lowest_energy_[gIndexRun,gIndexDesc]</span>

                <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="n">structure</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                    <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span>
                    <span class="c1">#&quot;is_lowest_energy&quot;: is_lowest_energy,</span>
                    <span class="s2">&quot;delta_e_rs_zb&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                    <span class="s2">&quot;chemical_formula&quot;</span><span class="p">:</span> <span class="n">chemical_formula</span><span class="p">,</span>
                    <span class="s2">&quot;gIndexRun&quot;</span><span class="p">:</span> <span class="n">gIndexRun</span><span class="p">,</span>
                    <span class="s2">&quot;gIndexDesc&quot;</span><span class="p">:</span> <span class="n">gIndexDesc</span><span class="p">,</span>
                    <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;particle_atom_number&quot;</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">atoms</span><span class="p">),</span>
                    <span class="s2">&quot;particle_position&quot;</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">atoms</span><span class="p">),</span>
                    <span class="s2">&quot;atomic_features&quot;</span><span class="p">:</span> <span class="n">atomic_features</span><span class="p">,</span>
                    <span class="s2">&quot;main_json_file_name&quot;</span><span class="p">:</span> <span class="n">json_file</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">outF</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">outF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ] }&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">outF</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="r_sigma"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.r_sigma">[docs]</a><span class="k">def</span> <span class="nf">r_sigma</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates r_sigma.</span>

<span class="sd">    John-Bloch&#39;s indicator1: |rp(A) + rs(A) - rp(B) -rs(B)| from Phys. Rev. Lett. 33, 1095 (1974).</span>

<span class="sd">    Input rp(A), rs(A), rp(B), rs(B)</span>
<span class="sd">    They need to be given in this order.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>


<div class="viewcode-block" id="r_pi"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.r_pi">[docs]</a><span class="k">def</span> <span class="nf">r_pi</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates r_pi.</span>

<span class="sd">    John-Bloch&#39;s indicator2: |rp(A) - rs(A)| +| rp(B) -rs(B)| from Phys. Rev. Lett. 33, 1095 (1974).</span>
<span class="sd">    Input rp(A), rs(A), rp(B), rs(B)</span>
<span class="sd">    They need to be given in this order.</span>
<span class="sd">    combine_features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>


<div class="viewcode-block" id="e_sqrt_z"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.e_sqrt_z">[docs]</a><span class="k">def</span> <span class="nf">e_sqrt_z</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates e/sqrt(val_Z).</span>

<span class="sd">    Es/sqrt(Zval) and Ep/sqrt(Zval) from Phys. Rev. B 85, 104104 (2012).</span>
<span class="sd">    Input Es(A) or Ep(A), val(A)  (A--&gt;B)</span>
<span class="sd">    They need to be given in this order.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">_get_scaling_factors</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates characteristic energy and length, given an atomic metadata&quot;&quot;&quot;</span>
    <span class="n">scaling_factor</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">col_unit</span> <span class="o">=</span> <span class="n">metadata_info</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

                <span class="c1"># check allowed values, to avoid problem with substance - NOT IDEAD</span>
                <span class="k">if</span> <span class="n">col_unit</span> <span class="o">==</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span>
                    <span class="n">scaling_factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">target_unit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">))</span>
                    <span class="c1"># divide all column by e_0</span>
                    <span class="c1">#df.loc[:, col] *= e_0</span>
                <span class="k">elif</span> <span class="n">col_unit</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
                    <span class="n">scaling_factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">,</span> <span class="n">target_unit</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">))</span>
                    <span class="c1"># divide all column by e_0</span>
                    <span class="c1">#df.loc[:, col] *= d_0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scaling_factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Feature units are not energy nor lengths. &quot;</span>
                                 <span class="s2">&quot;No scale to characteristic length.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">scaling_factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Feature units not included in metadata&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scaling_factor</span>


<span class="k">def</span> <span class="nf">_my_power_2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_power_3</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_power_m1</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_power_m2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_power_m3</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_abs_sqrt</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrtabs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">_my_exp</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_my_exp_power_2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_my_exp_power_3</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_my_sum</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_my_abs_sum</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_my_abs_diff</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_my_diff</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_my_div</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_my_sum_power_2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_sum_power_3</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">pow</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_sum_exp</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_my_sum_exp_power_2</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_my_sum_exp_power_3</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>


<div class="viewcode-block" id="combine_features"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.combine_features">[docs]</a><span class="k">def</span> <span class="nf">combine_features</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">metadata_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_operations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">derived_features</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate combination of features given a dataframe and a list of allowed operations.</span>

<span class="sd">    For the exponentials, we introduce a characteristic energy/length</span>
<span class="sd">    converting the</span>
<span class="sd">    ..todo:: Fix under/overflow errors, and introduce handling of exceptions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">allowed_operations</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selected operations:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allowed_operations</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No allowed operations selected.&#39;</span><span class="p">)</span>

    <span class="c1"># make derived features</span>
    <span class="k">if</span> <span class="n">derived_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;r_sigma&#39;</span> <span class="ow">in</span> <span class="n">derived_features</span><span class="p">:</span>
            <span class="c1"># calculate r_sigma and r_pi [Phys. Rev. Lett. 33, 1095(1974)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Including rs and rp to allow r_sigma calculation&#39;</span><span class="p">)</span>
            <span class="n">radii_s_p</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;atomic_rp_max(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rs_max(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rp_max(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rs_max(B)&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;r_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">radii_s_p</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r_sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;r_pi&#39;</span> <span class="ow">in</span> <span class="n">derived_features</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Including rs and rp to allow r_pi calculation&#39;</span><span class="p">)</span>
            <span class="n">radii_s_p</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;atomic_rp_max(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rs_max(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rp_max(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;atomic_rs_max(B)&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;r_pi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">radii_s_p</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r_pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculate Es/sqrt(Zval) and Ep/sqrt(Zval)</span>
<span class="c1">#    e_val_z = [&#39;Es(A)&#39;, &#39;val(A)&#39;]</span>
<span class="c1">#    df[&#39;Es(A)/sqrt(Zval(A))&#39;] = df[e_val_z].apply(e_sqrt_z, axis=1)</span>
<span class="c1">#    e_val_z = [&#39;Es(B)&#39;, &#39;val(B)&#39;]</span>
<span class="c1">#    df[&#39;Es(B)/sqrt(Zval(B))&#39;] = df[e_val_z].apply(e_sqrt_z, axis=1)</span>
<span class="c1">#</span>
<span class="c1">#    e_val_z = [&#39;Ep(A)&#39;, &#39;val(A)&#39;]</span>
<span class="c1">#    df[&#39;Ep(A)/sqrt(Zval(A))&#39;] = df[e_val_z].apply(e_sqrt_z, axis=1)</span>
<span class="c1">#    e_val_z = [&#39;Ep(B)&#39;, &#39;val(B)&#39;]</span>
<span class="c1">#    df[&#39;Ep(B)/sqrt(Zval(B))&#39;] = df[e_val_z].apply(e_sqrt_z, axis=1)</span>

    <span class="n">columns_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># define subclasses of features (see Phys. Rev. Lett. 114, 105503(2015) Supp. info. pag.1)</span>
    <span class="c1"># make a dictionary {feature: subgroup}</span>
    <span class="c1"># features belonging to a0 will not be combined, just added at the end</span>

<span class="c1">#    dict_features = {</span>
<span class="c1">#        u&#39;val(B)&#39;: &#39;a0&#39;, u&#39;val(A)&#39;: &#39;a0&#39;,</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;period__el0&#39;:&#39;a0&#39;,</span>
<span class="c1">#        u&#39;period__el1&#39;:&#39;a0&#39;,</span>
<span class="c1">#        u&#39;atomic_number__el0&#39;: &#39;a0&#39;,</span>
<span class="c1">#        u&#39;atomic_number__el1&#39;: &#39;a0&#39;,</span>
<span class="c1">#        u&#39;group__el0&#39;: &#39;a0&#39;,</span>
<span class="c1">#        u&#39;group__el1&#39;: &#39;a0&#39;,</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;atomic_ionization_potential__el0&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_ionization_potential__el1&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_electron_affinity__el0&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_electron_affinity__el1&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_homo_lumo_diff__el0&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_homo_lumo_diff__el1&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_electronic_binding_energy_el0&#39;: &#39;a1&#39;,</span>
<span class="c1">#        u&#39;atomic_electronic_binding_energy_el1&#39;: &#39;a1&#39;,</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;HOMO(A)&#39;: &#39;a2&#39;, u&#39;LUMO(A)&#39;: &#39;a2&#39;, u&#39;HOMO(B)&#39;: &#39;a2&#39;, u&#39;LUMO(B)&#39;: &#39;a2&#39;,</span>
<span class="c1">#        u&#39;HL_gap_AB&#39;: &#39;a2&#39;,</span>
<span class="c1">#        u&#39;Ebinding_AB&#39;: &#39;a2&#39;,</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;atomic_rs_max__el0&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_rs_max__el1&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_rp_max__el0&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_rp_max__el1&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_rd_max__el0&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_rd_max__el1&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_r_by_2_dimer__el0&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;atomic_r_by_2_dimer__el1&#39;: &#39;a3&#39;,</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;d_AB&#39;: &#39;a3&#39;,</span>
<span class="c1">#        u&#39;r_sigma&#39;: &#39;a3&#39;, u&#39;r_pi&#39;: &#39;a3&#39;,</span>
<span class="c1">#</span>
<span class="c1">#        u&#39;Eh&#39;: &#39;a4&#39;, u&#39;C&#39;: &#39;a4&#39;</span>
<span class="c1">#        }</span>

    <span class="n">dict_features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">u</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;a0&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_number&#39;</span><span class="p">:</span> <span class="s1">&#39;a0&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;a0&#39;</span><span class="p">,</span>

        <span class="sa">u</span><span class="s1">&#39;atomic_ionization_potential&#39;</span><span class="p">:</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_electron_affinity&#39;</span><span class="p">:</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_homo_lumo_diff&#39;</span><span class="p">:</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_electronic_binding_energy&#39;</span><span class="p">:</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span>

        <span class="sa">u</span><span class="s1">&#39;atomic_homo&#39;</span><span class="p">:</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;atomic_lumo&#39;</span><span class="p">:</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span>


        <span class="sa">u</span><span class="s1">&#39;atomic_rs_max&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_rp_max&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_rd_max&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;atomic_r_by_2_dimer&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span>

        <span class="sa">u</span><span class="s1">&#39;r_sigma&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;r_pi&#39;</span><span class="p">:</span> <span class="s1">&#39;a3&#39;</span>

    <span class="p">}</span>

    <span class="c1"># standardize the data -</span>
    <span class="c1"># we cannot reproduce the PRL if we standardize the data</span>
    <span class="c1">#df_a0 = (df_a0 - df_a0.mean()) / (df_a0.max() - df_a0.min())</span>
    <span class="c1">#df_a1 = (df_a1 - df_a1.mean()) / (df_a1.max() - df_a1.min())</span>
    <span class="c1">#df_a2 = (df_a2 - df_a2.mean()) / (df_a2.max() - df_a2.min())</span>
    <span class="c1">#df_a3 = (df_a3 - df_a3.mean()) / (df_a3.max() - df_a3.min())</span>
    <span class="c1">#df_a4 = (df_a4 - df_a4.mean()) / (df_a4.max() - df_a4.min())</span>


<span class="c1">#    df_a0 = df[[col for col in columns_ if dict_features.get(col)==&#39;a0&#39;]].astype(&#39;float32&#39;)</span>
    <span class="n">df_a0</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_</span> <span class="k">if</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a0&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">df_a1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_</span> <span class="k">if</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">df_a2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_</span> <span class="k">if</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">df_a3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_</span> <span class="k">if</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">df_a4</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_</span> <span class="k">if</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="n">col_a0</span> <span class="o">=</span> <span class="n">df_a0</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">col_a1</span> <span class="o">=</span> <span class="n">df_a1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">col_a2</span> <span class="o">=</span> <span class="n">df_a2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">col_a3</span> <span class="o">=</span> <span class="n">df_a3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">col_a4</span> <span class="o">=</span> <span class="n">df_a4</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1">#  this list will at the end all the dataframes created</span>
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">df_b0_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_b1_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_b2_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_b3_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_c3_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_d3_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_e3_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_f1_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_f2_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_f3_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_x1_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_x2_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_x_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create b0: absolute differences and sums of a0</span>
    <span class="c1"># this is not in the PRL.</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|+|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|-|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_div</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_div</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># we kept itertools.combinations to make the code more uniform with the binary operations</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;^2&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^2&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_power_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;^3&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^3&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_power_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a0</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_exp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create b1: absolute differences and sums of a1</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|+|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|-|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create b2: absolute differences and sums of a2</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|+|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|-|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create b3: absolute differences and sums of a3</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|+|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;|-|&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_abs_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_b3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create c3: two steps:</span>
    <span class="c1"># 1) squares of a3 - unary operations</span>
    <span class="c1"># we kept itertools.combinations to make the code more uniform with the binary operations</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;^2&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^2&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_power_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_c3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;^3&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^3&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_power_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_c3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># 2) squares of b3 (only sums) --&gt; sum squared of a3</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;^2&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)^2&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum_power_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_c3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;^3&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)^3&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum_power_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_c3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create d3: two steps:</span>
    <span class="c1"># 1) exponentials of a3 - unary operations</span>
    <span class="c1"># we kept itertools.combinations to make the code more uniform with the binary operations</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
            <span class="c1"># and multiply each column by the scaling factor</span>
            <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
            <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_exp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_d3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># 2) exponentials of b3 (only sums) --&gt; exponential of sum of a3</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span>
            <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
            <span class="c1"># and multiply each column by the scaling factor</span>
            <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
            <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum_exp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_d3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="c1"># create e3: two steps:</span>
    <span class="c1"># 1) exponentials of squared a3 - unary operations</span>
    <span class="c1"># we kept itertools.combinations to make the code more uniform with the binary operations</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_operations</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^2)&#39;</span><span class="p">]</span>
            <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
            <span class="c1"># and multiply each column by the scaling factor</span>
            <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
            <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_exp_power_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_e3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;^3&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_operations</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp(&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;^3)&#39;</span><span class="p">]</span>
                <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
                <span class="c1"># and multiply each column by the scaling factor</span>
                <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
                <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_exp_power_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_e3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OverflowError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dropping feature combination that caused under/overflow.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># 2) exponentials of b3 (only sums) --&gt; exponential of sum of a3</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">col_a3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_operations</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp((&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)^2)&#39;</span><span class="p">]</span>
            <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
            <span class="c1"># and multiply each column by the scaling factor</span>
            <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
            <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum_exp_power_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_e3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

        <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;^3&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_operations</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp((&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)^3)&#39;</span><span class="p">]</span>
                <span class="c1"># find scaling factor for e_0 or d_0 for scaling</span>
                <span class="c1"># and multiply each column by the scaling factor</span>
                <span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">_get_scaling_factors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="n">metadata_info</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>
                <span class="n">df_subset</span> <span class="o">=</span> <span class="n">df_a3</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)]</span> <span class="o">*</span> <span class="n">scaling_factors</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">df_subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_my_sum_exp_power_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_e3_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OverflowError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dropping feature combination that caused under/overflow.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># make dataframes from lists, check if they are not empty</span>
    <span class="c1"># we make there here because they are going to be used to further</span>
    <span class="c1"># combine the features</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a0</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a1</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a1</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a2</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a2</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a3</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a3</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a3</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a4</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_a4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b0_list</span><span class="p">:</span>
        <span class="n">df_b0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_b0_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_b0</span> <span class="o">=</span> <span class="n">df_b0</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_b0</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./df_b0.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b1_list</span><span class="p">:</span>
        <span class="n">df_b1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_b1_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_b1</span> <span class="o">=</span> <span class="n">df_b1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b1</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b2_list</span><span class="p">:</span>
        <span class="n">df_b2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_b2_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_b2</span> <span class="o">=</span> <span class="n">df_b2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b2</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b3_list</span><span class="p">:</span>
        <span class="n">df_b3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_b3_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_b3</span> <span class="o">=</span> <span class="n">df_b3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b3</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_b3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_c3_list</span><span class="p">:</span>
        <span class="n">df_c3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_c3_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_c3</span> <span class="o">=</span> <span class="n">df_c3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_c3</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_c3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_d3_list</span><span class="p">:</span>
        <span class="n">df_d3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_d3_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_d3</span> <span class="o">=</span> <span class="n">df_d3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_d3</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_d3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_e3_list</span><span class="p">:</span>
        <span class="n">df_e3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_e3_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_e3</span> <span class="o">=</span> <span class="n">df_e3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_x2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_e3</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_e3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_x1_list</span><span class="p">:</span>
        <span class="n">df_x1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_x1_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_x1</span> <span class="o">=</span> <span class="n">df_x1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">df_x2_list</span><span class="p">:</span>
        <span class="n">df_x2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_x2_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_x2</span> <span class="o">=</span> <span class="n">df_x2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># create f1 - abs differences and sums of b1 without repetitions</span>
    <span class="c1"># TO DO: calculate f1</span>

    <span class="c1"># create x - ratios of any of {a_i, b_i} i=1,2,3</span>
    <span class="c1"># with any of {c3, d3, e3} - typo in the PRL - no a3</span>
    <span class="c1"># total = (4+4+6+12+12+30)*(21+21+21) = 68*63 = 4284</span>
    <span class="c1"># for subset in itertools.combinations(col_a3, 1):</span>
    <span class="c1">#    if &#39;exp&#39; in allowed_operations:</span>
    <span class="c1">#        cols = [&#39;exp(&#39;+subset[0]+&#39;^2)&#39;]</span>
    <span class="c1">#        data = df_a3[list(subset)].apply(_my_exp_power_2, axis=1)</span>
    <span class="c1">#        df_e3_list.append(pd.DataFrame(data, columns=cols))</span>

    <span class="k">if</span> <span class="n">df_x1_list</span> <span class="ow">and</span> <span class="n">df_x2_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">el_x1</span> <span class="ow">in</span> <span class="n">col_x1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">el_x2</span> <span class="ow">in</span> <span class="n">col_x2</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">allowed_operations</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">el_x1</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">el_x2</span><span class="p">]</span>
                    <span class="c1"># now the operation is between two dataframes</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">df_x1</span><span class="p">[</span><span class="n">el_x1</span><span class="p">]</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">df_x2</span><span class="p">[</span><span class="n">el_x2</span><span class="p">])</span>
                    <span class="n">df_x_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">df_f1_list</span><span class="p">:</span>
        <span class="n">df_f1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_f1_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_f1</span> <span class="o">=</span> <span class="n">df_f1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_f1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_x_list</span><span class="p">:</span>
        <span class="n">df_x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_x_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_x</span> <span class="o">=</span> <span class="n">df_x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_x</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> l1-l0 feature creation&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a0</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup a0: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup a0: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a0</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_a0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup a0.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a1</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup a1: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup a1: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup a1.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup a2: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup a2: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_a2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup a2.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a3</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup a3: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup a3: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_a3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup a3.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_a4</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup a4: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a4</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup a4: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_a3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_a4</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup a4.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b0_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup b0: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup b0: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b0</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_b0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup b0.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b1_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup b1: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup b1: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_b1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup b1.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b2_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup b2: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup b2: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_b2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup b2.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_b3_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup b3: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup b3: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_b3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_b3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup b3.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_c3_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup c3: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_c3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup c3: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_c3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_c3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup c3.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_d3_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup d3: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_d3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup d3: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_d3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_d3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup d3.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_e3_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup e3: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_e3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup e3: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_e3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_e3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup e3.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_f1_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup f1: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_f1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup f1: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_f1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_f1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup f1.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_x_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of features in subgroup x: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Example of feature in subgroup x: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No features in subgroup x.&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Please see Phys. Rev. Lett. 114, 105503(2015) Supplementary Information </span><span class="se">\n</span><span class="s1"> for more details.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_list</span><span class="p">:</span>
        <span class="n">df_combined_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No features selected. Please select at least two primary features.&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of total features generated: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_combined_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">df_combined_features</span></div>


<div class="viewcode-block" id="l1_l0_minimization"><a class="viewcode-back" href="../../../ai4materials.models.l1_l0.html#ai4materials.models.l1_l0.l1_l0_minimization">[docs]</a><span class="k">def</span> <span class="nf">l1_l0_minimization</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span>
                       <span class="n">energy_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">print_lasso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lambda_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lassonumber</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                       <span class="n">max_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lambda_grid_points</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lambda_max_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lambda_min_factor</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Select an optimal descriptor using a combined l1-l0 procedure.</span>

<span class="sd">    1. step (l 1): Solve the LASSO minimization problem</span>

<span class="sd">    .. math::</span>
<span class="sd">        argmin_c {||P-Dc||^2 + \lambda |c|_1}</span>

<span class="sd">    for different lambdas, starting from a &#39;high&#39; lambda.</span>
<span class="sd">    Collect all indices(Features) i appearing with nonzero coefficients c_i,</span>
<span class="sd">    while decreasing lambda, until size of collection equals `lassonumber`.</span>

<span class="sd">    2. step (l 0): Check the least-squares errors for all single features/pairs/triples/... of</span>
<span class="sd">                   collection from 1. step. Choose the single/pair/triple/... with the lowest</span>
<span class="sd">                   mean squared error (MSE) to be the best 1D/2D/3D-descriptor.</span>


<span class="sd">    Parameters:</span>

<span class="sd">    y_true : array, [n_samples]</span>
<span class="sd">        Array with the target property (ground truth)</span>

<span class="sd">    D : array, [n_samples, n_features]</span>
<span class="sd">        Matrix with the data.</span>

<span class="sd">    features : list of strings</span>
<span class="sd">        List of feature names. Needs to be in the same order as the feature vectors in D</span>

<span class="sd">    dimrange : list of int</span>
<span class="sd">        Specify for which dimensions the optimal descriptor is calculated.</span>
<span class="sd">        It is the number of feature vectors used in the linear combination</span>

<span class="sd">    lassonumber : int, default 25</span>
<span class="sd">        The number of features, which will be collected in ther l1-step</span>

<span class="sd">    lamdba_grid_points : int, default 100</span>
<span class="sd">        Number of lamdbas between lamdba_max and lambdba_min for which the l1-problem shall be solved.</span>
<span class="sd">        Sometimes a denser grid could be needed, if the lamda-steps are too high.</span>
<span class="sd">        This can be checked with &#39;print_lasso&#39;. `lamdba_max` and `lamdba_min` are chosen as in</span>
<span class="sd">        Tibshirani&#39;s paper &quot;Regularization Paths for Generalized Linear Models via Coordinate Descent&quot;.</span>
<span class="sd">        The values in between are generated on the log scale.</span>

<span class="sd">    lambda_min_factor : float, default 0.001</span>
<span class="sd">        Sets `lam_min` = `lambda_min_factor` * `lam_max`.</span>

<span class="sd">    lambda_max_factor : float, default 1.0</span>
<span class="sd">        Sets calculated `lam_max` = `lam_max` * `lambda_max_factor`.</span>

<span class="sd">    print_lasso: bool, default `True`</span>
<span class="sd">        Prints the indices of coulumns of `D` with nonzero coefficients for each lambda.</span>

<span class="sd">    lambda_grid: array</span>
<span class="sd">        The list/array of lambda values for the l1-problem can be chosen by the user.</span>
<span class="sd">        The list/array should start from the highest number and lambda_i &gt; lamda_i+1 should hold.</span>
<span class="sd">        (?) `lambda_grid_point` is then ignored. (?)</span>

<span class="sd">    Returns:</span>

<span class="sd">    list of panda dataframes</span>
<span class="sd">    (D&#39;, c&#39;, selected_features) :</span>
<span class="sd">        A list of tuples (D&#39;,c&#39;,selected_features) for each dimension.</span>
<span class="sd">        `selected_features` is a list of strings. D&#39;*c&#39; is the selected linear model/fit where the last column</span>
<span class="sd">        of `D` is a vector with ones.</span>


<span class="sd">    References:</span>

<span class="sd">    .. [1] Luca M. Ghiringhelli, Jan Vybiral, Sergey V. Levchenko, Claudia Draxl, and Matthias Scheffler,</span>
<span class="sd">        &quot;Big Data of Materials Science: Critical Role of the Descriptor&quot;</span>
<span class="sd">        Phys. Rev. Lett. 114, 105503 (2015)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dimrange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">compounds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>

    <span class="c1"># standardize D</span>
    <span class="n">Dstan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>

    <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1">#lambda_grid=[pow(1.7,i) for i in np.arange(-40.,-1,1.)]</span>
    <span class="c1"># lambda_grid.sort(reverse=True)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting optimal descriptors.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lambda_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># find max lambda, and build lambda grid as in</span>
            <span class="c1"># Tibshirani&#39;s paper &quot;Regularization Paths for Generalized Linear</span>
            <span class="c1"># Models via Coordinate Descent&quot;. Here lam_max can be set to a higher</span>
            <span class="c1"># with a factor lambda_max_factor</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">Dstan</span><span class="p">))</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>

        <span class="n">lam_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">compounds</span><span class="p">)</span>
        <span class="n">lam_min</span> <span class="o">=</span> <span class="n">lam_max</span> <span class="o">*</span> <span class="n">lambda_min_factor</span>
        <span class="n">lam_max</span> <span class="o">=</span> <span class="n">lambda_max_factor</span> <span class="o">*</span> <span class="n">lam_max</span>
        <span class="n">log_max</span><span class="p">,</span> <span class="n">log_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lam_max</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lam_min</span><span class="p">)</span>

        <span class="n">lambda_grid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">log_min</span><span class="p">,</span> <span class="n">log_max</span><span class="p">,</span> <span class="n">lambda_grid_points</span><span class="p">)]</span>
        <span class="n">lambda_grid</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># LASSO begin, iter over lamda grid, and collect all indices(Features)</span>
    <span class="c1"># with nonzero coefficient until len(collection)=lassonumber</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">print_lasso</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;lambda      #collected   Indices&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lambda_grid</span><span class="p">):</span>
        <span class="n">lasso</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span> <span class="n">copy_X</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">max_iter</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s1">&#39;cyclic&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Dstan</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">lasso</span><span class="o">.</span><span class="n">coef_</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">coef</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_lasso</span><span class="p">:</span>  <span class="c1"># print the indices of nonzero coefficients for a given lambda.</span>
                            <span class="c1"># (It is NOT the collection at that moment)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">   </span><span class="si">%s</span><span class="s1">   </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">coef</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lassonumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">collection</span><span class="p">[:</span><span class="n">lassonumber</span><span class="p">])</span>
    <span class="c1"># LASSO end</span>

    <span class="c1"># collection is the list with the features that have been collected</span>
    <span class="n">len_collection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">len_collection</span> <span class="o">&lt;</span> <span class="n">lassonumber</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Only </span><span class="si">%s</span><span class="s2"> features are collected&quot;</span> <span class="o">%</span> <span class="n">len_collection</span><span class="p">)</span>
    <span class="c1"># make small matrix with size of (compounds,lassonumber), only with  selected features from LASSO</span>
    <span class="n">D_collection</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">collection</span><span class="p">]</span>
    <span class="n">D_collection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">D_collection</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">compounds</span><span class="p">)))</span>

    <span class="c1"># get the different dimensional descriptor and save the</span>
    <span class="c1"># tuple (D_model, coefficients, selected_features) for each dimension in the list out</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">dimrange</span><span class="p">:</span>

        <span class="c1"># L0: save for each single Feature/ pair, triple/... the Least-Squares-Error</span>
        <span class="c1"># with its coefficient and index in Dictionary MSEdic</span>
        <span class="n">MSEdic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">permu</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_collection</span><span class="p">),</span> <span class="n">dimension</span><span class="p">):</span>
            <span class="n">D_ls</span> <span class="o">=</span> <span class="n">D_collection</span><span class="p">[:,</span> <span class="n">permu</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">D_ls</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># if there are linear dependencies in D_ls np.linalg.lstsq gives no error and len(x[1])==0.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                   <span class="c1"># (There could be other reasons, too...which should/could be checked)</span>
                <span class="n">MSE</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">compounds</span>
                <span class="n">MSEdic</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">MSE</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">permu</span><span class="p">]})</span>

        <span class="c1"># check if MSEdic is empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">MSEdic</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find configuration with lowest MSE.</span><span class="se">\n</span><span class="s1"> Try to select &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;more features</span><span class="se">\n</span><span class="s1"> or reduce the number of the descriptor dimension. &#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># select the model with the lowest MSE</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MSEdic</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Root Mean Squared Error (RMSE) for </span><span class="si">{0}</span><span class="s2">D descriptor: </span><span class="si">{1:.6e}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">minimum</span><span class="p">),</span> <span class="n">energy_unit</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MSEdic</span><span class="p">[</span><span class="n">minimum</span><span class="p">]</span>
        <span class="n">coefficients</span><span class="p">,</span> <span class="n">good_permu</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># transform the D_collection-indices into D-indices, and get strings for selected features</span>
        <span class="c1"># from the list &#39;features&#39; , and get D_model</span>
        <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="n">collection</span><span class="p">[</span><span class="n">gp</span><span class="p">]]</span> <span class="k">for</span> <span class="n">gp</span> <span class="ow">in</span> <span class="n">good_permu</span><span class="p">]</span>
        <span class="n">D_model</span> <span class="o">=</span> <span class="n">D_collection</span><span class="p">[:,</span> <span class="n">good_permu</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)]</span>

        <span class="c1"># save the model for the actual dimension and strings of features</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">D_model</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">))</span>

        <span class="c1"># print in terminal</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">D case: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimension</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dimension</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.6e</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.6e</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

        <span class="c1"># calculate E_predict</span>
        <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D_model</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">))</span>

        <span class="c1"># RMSE (it should be the same as before): sqrt(mean_squared_error(P, P_pred))</span>

        <span class="c1"># create panda dataframe</span>
        <span class="n">selected_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">D_model</span>

        <span class="n">out_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">selected_features</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out_df</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Angelo Ziletti.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>