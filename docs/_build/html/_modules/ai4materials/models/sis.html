

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ai4materials.models.sis &mdash; ai4materials v0.1.0</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="ai4materials v0.1.0" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/>
    <link href="../../../_static/nomad-analytics.css" rel="stylesheet" type="text/css">


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ai4materials
          

          
            
            <img src="../../../_static/ai_for_materials_logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.dataprocessing.html">Data preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.descriptors.html">Representing crystal structures: descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.wrappers.html">Creating and loading materials science datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.models.html">Regression and classification models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.interpretation.html">Neural network interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ai4materials</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ai4materials.models.sis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ai4materials.models.sis</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding=utf-8</span>
<span class="c1"># Copyright 2016-2018 Emre Ahmetick</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Emre Ahmetick&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2018, Emre Ahmetick&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Emre Ahmetick&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;ahmetick@fhi-berlin.mpg.de&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;23/09/18&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ai4materials.utils.utils_config</span> <span class="k">import</span> <span class="n">SSH</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sched</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">rmtree</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">Popen</span>
<span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">opop</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>


<span class="n">F_unit</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;IP(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;IP(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;EA(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;EA(B)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;E_HOMO(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;E_HOMO(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;E_LUMO(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;E_LUMO(B)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;r_s(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_s(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_p(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_p(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_d(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_d(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_sigma(AB)&#39;</span><span class="p">,</span> <span class="s1">&#39;r_pi(AB)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z_val(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z_val(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;period(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;period(B)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;d(AB)&#39;</span><span class="p">,</span> <span class="s1">&#39;d(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;d(B)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;E_b(AB)&#39;</span><span class="p">,</span> <span class="s1">&#39;E_b(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;E_b(B)&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;HL_gap(AB)&#39;</span><span class="p">,</span> <span class="s1">&#39;HL_gap(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;HL_gap(B)&#39;</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">reals</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;IP(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IP(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EA(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EA(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_HOMO(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_HOMO(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_LUMO(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_LUMO(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_s(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_s(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_p(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_p(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_d(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_d(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_sigma(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_pi(AB)&#39;</span><span class="p">]</span>
<span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Z(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z_val(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Z_val(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;period(A)&#39;</span><span class="p">,</span> <span class="s1">&#39;period(B)&#39;</span><span class="p">]</span>

<span class="n">standard_format</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;IP(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IP(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EA(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EA(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_HOMO(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_HOMO(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_LUMO(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_LUMO(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_s(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_s(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_p(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_p(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_d(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_d(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Z(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Z(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Z_val(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Z_val(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E_b(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HL_gap(B)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_sigma(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_pi(AB)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;period(A)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;period(B)&#39;</span><span class="p">]</span>
<span class="n">converted_format</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;ipA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ipB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;eaA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;eaB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;homoA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;homoB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lumoA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lumoB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rsA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rsB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rpA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rpB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rdA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rdB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;disAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;disA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;disB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ebAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ebA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ebB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hlgapAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hlgapA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hlgapB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rsigmaAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rpiAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;periodA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;periodB&#39;</span><span class="p">]</span>

<span class="n">standard_2_converted</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">standard_format</span><span class="p">,</span> <span class="n">converted_format</span><span class="p">))</span>
<span class="n">converted_2_standard</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">converted_format</span><span class="p">,</span> <span class="n">standard_format</span><span class="p">))</span>


<span class="sd">&quot;&quot;&quot; Set logger for outputs as errors, warnings, infos. &quot;&quot;&quot;</span>

<span class="c1">#</span>
<span class="c1"># try:</span>
<span class="c1">#     hdlr = logging.FileHandler(configs[&quot;output_file&quot;], mode=&#39;a&#39;)</span>
<span class="c1"># except:</span>
<span class="c1">#     hdlr = logging.FileHandler(configs[&quot;output_file&quot;], mode=&#39;w&#39;)</span>
<span class="c1">#</span>
<span class="c1"># level = logging.getLevelName(configs[&quot;log_level_general&quot;])</span>
<span class="c1">#</span>
<span class="c1"># logger = logging.getLogger(__name__)</span>
<span class="c1"># logger.setLevel(level)</span>
<span class="c1"># logging.basicConfig(level=level)</span>
<span class="c1"># FORMAT = &quot;%(levelname)s: %(message)s&quot;</span>
<span class="c1"># formatter = logging.Formatter(fmt=FORMAT)</span>
<span class="c1"># handler = logging.StreamHandler()</span>
<span class="c1"># handler.setFormatter(formatter)</span>
<span class="c1"># hdlr.setFormatter(formatter)</span>
<span class="c1"># logger.addHandler(handler)</span>
<span class="c1"># logger.addHandler(hdlr)</span>
<span class="c1"># logger.setLevel(level)</span>
<span class="c1"># logger.propagate = False</span>
<span class="c1">#</span>
<span class="c1"># __metainfopath__ = configs[&quot;meta_info_file&quot;]</span>

<span class="c1"># START PARAMETERS REFERENCE</span>


<span class="c1"># In the following lists of tuples the order of the items might be important. Thus no dict is used.</span>
<span class="c1"># If value is tuple, then only one of items are possible as value when passing the dict control to the SIS class.</span>
<span class="n">Tuple_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># FCDI</span>
    <span class="p">(</span><span class="s1">&#39;mpiname&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>    <span class="c1"># code will be run by: mpiname codename. set mpiname=&#39;&#39; for serial run.</span>
    <span class="p">(</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>               <span class="c1"># starting iteration (can be n if iteration up to n-1 already calculated before)</span>
    <span class="p">(</span><span class="s1">&#39;ptype&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;quanti&#39;</span><span class="p">,</span> <span class="s1">&#39;quali&#39;</span><span class="p">)),</span>      <span class="c1"># property type: &#39;quanti&#39;(quantitative),&#39;quali&#39;(qualitative)</span>
    <span class="p">(</span><span class="s1">&#39;ntask&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>      <span class="c1"># number of tasks (properties)</span>
    <span class="p">(</span><span class="s1">&#39;nsample&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>   <span class="c1"># number of samples for each task (and group for classification, e.g. (4,3,5),(7,9) )</span>
    <span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>     <span class="c1"># for classification, the boundary tolerance</span>
    <span class="c1"># FC</span>
    <span class="p">(</span><span class="s1">&#39;nsf&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of scalar features (i.e.: the atomic parameters)</span>
    <span class="p">(</span><span class="s1">&#39;task_arr&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of tasks arranged in columns</span>
    <span class="p">(</span><span class="s1">&#39;rung&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># rung of feature spaces (rounds of combination)</span>
    <span class="p">(</span><span class="s1">&#39;opset&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>  <span class="c1"># oprators(currently: (+)(-)(*)(/)(exp)(log)(^-1)(^2)(^3)(sqrt)(|-|) )</span>
    <span class="p">(</span><span class="s1">&#39;ndimtype&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of dimension types (for dimension analysis)</span>
    <span class="p">(</span><span class="s1">&#39;dimclass&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>   <span class="c1"># specify features in each class denoted by ( )</span>
    <span class="p">(</span><span class="s1">&#39;allele&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>  <span class="c1"># Should all elements appear in each of the selected features?</span>
    <span class="p">(</span><span class="s1">&#39;nele&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of element (&lt;=6): useful only when symm=.true. and/or allele=.true.</span>
    <span class="p">(</span><span class="s1">&#39;maxfval_lb&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>  <span class="c1"># features having the max. abs. data value &lt;maxfval_lb will not be selected</span>
    <span class="p">(</span><span class="s1">&#39;maxfval_ub&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>  <span class="c1"># features having the max. abs. data value &gt;maxfval_ub will not be selected</span>
    <span class="p">(</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># total number of features selected by sure independent screen</span>
    <span class="c1"># DI</span>
    <span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;L1L0&#39;</span><span class="p">,</span> <span class="s1">&#39;L0&#39;</span><span class="p">)),</span>  <span class="c1"># &#39;L1L0&#39; or &#39;L0&#39;</span>
    <span class="p">(</span><span class="s1">&#39;size_fs&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of total features in each taskxxx.dat (same for all)</span>
    <span class="p">(</span><span class="s1">&#39;nfL0&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># number of features for L0(ntotf-&gt;nfL0 if nfL0&gt;ntotf)</span>
    <span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS_RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;CV_RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;CV_MAE&#39;</span><span class="p">)),</span>        <span class="c1"># metric for the evaluation: LS_RMSE,CV_RMSE,CV_MAE</span>
    <span class="p">(</span><span class="s1">&#39;n_eval&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>                 <span class="c1"># number of top models (based on fitting) to be evaluated by the metric</span>
    <span class="p">(</span><span class="s1">&#39;CV_fold&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># k-fold CV (&gt;=2)</span>
    <span class="p">(</span><span class="s1">&#39;CV_repeat&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="c1"># repeated k-fold CV</span>
    <span class="p">(</span><span class="s1">&#39;n_out&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>         <span class="c1"># number of top models to be output, off when =0</span>
<span class="p">]</span>

<span class="c1"># Generate lists and dics for easier coding later.</span>
<span class="n">Param_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">Tuple_list</span><span class="p">]</span>
<span class="n">Param_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Tuple_list</span><span class="p">)</span>

<span class="c1"># Important: control reference. Specifies how the structure of input control dict to SIS class should look like.</span>
<span class="c1"># If key tuple, then value has to be tuple, too. A tuple stands for the option that on and only one of the keys</span>
<span class="c1"># have to set.</span>
<span class="n">control_ref</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;local_paths&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;local_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;SIS_input_folder_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
    <span class="p">(</span><span class="s1">&#39;local_run&#39;</span><span class="p">,</span> <span class="s1">&#39;remote_run&#39;</span><span class="p">):</span> <span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;SIS_code_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;mpi_command&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;SIS_code_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;remote_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;eos&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="s1">&#39;mpi_command&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;key_file&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">):</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)}</span>
    <span class="p">),</span>
    <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;rung&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;subs_sis&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;desc_dim&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;opset&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="s1">&#39;ptype&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;quanti&#39;</span><span class="p">,</span> <span class="s1">&#39;quali&#39;</span><span class="p">)},</span>
    <span class="s1">&#39;advanced_parameters&#39;</span><span class="p">:</span> <span class="n">Param_dic</span>
<span class="p">}</span>

<span class="c1"># All keys which do not need to be set in input control dict tree. If they are not set, default values are used.</span>
<span class="n">not_mandotary</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;advanced_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;eos&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;DI&#39;</span><span class="p">,</span> <span class="s1">&#39;FCDI&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Param_key_list</span>

<span class="c1"># Availabel OPs for the SIS fortran code, at the moment.</span>
<span class="n">available_OPs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;exp-&#39;</span><span class="p">,</span> <span class="s1">&#39;^-1&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">,</span> <span class="s1">&#39;^3&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;|-|&#39;</span><span class="p">,</span> <span class="s1">&#39;SCD&#39;</span><span class="p">,</span> <span class="s1">&#39;^6&#39;</span><span class="p">]</span>

<span class="n">un_OP</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">,</span> <span class="s1">&#39;exp-&#39;</span><span class="p">,</span> <span class="s1">&#39;^-1&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">,</span> <span class="s1">&#39;^3&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;SCD&#39;</span><span class="p">,</span> <span class="s1">&#39;^6&#39;</span><span class="p">]</span>
<span class="n">bin_OP</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]</span>
<span class="n">bin_OP_bino</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;|-|&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span>
<span class="c1"># END PARAMETERS REFERENCE</span>


<div class="viewcode-block" id="SIS"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS">[docs]</a><span class="k">class</span> <span class="nc">SIS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Python interface with the fortran SIS+(Sure Independent Screening)+L0/L1L0 code.</span>

<span class="sd">    The SIS+(Sure Independent Screening)+L0/L1L0 is a greedy algorithm. It enhances the OMP, by considering</span>
<span class="sd">    not only the closest feature vector to the residual in each step, but collects the closest &#39;n_SIS&#39; features vectors.</span>
<span class="sd">    The final model is then built after a given number of iterations by determining the (approximately) best linear combination</span>
<span class="sd">    of the collected features using the L0 (L1-L0) algorithm.</span>

<span class="sd">    To execute the code, besides the SIS code parameters also folder paths are needed as well as account</span>
<span class="sd">    information of a remote machine to let the code be executed on it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : array, [n_sample]; list; [n_sample]</span>
<span class="sd">        P refers to the target (label). If ptype = &#39;quali&#39; list of ints is required</span>

<span class="sd">    D : array, [n_sample, n_features]</span>
<span class="sd">        D refers to the feature matrix. The SIS code calculates algebraic combinations</span>
<span class="sd">        of the features and then applies the SIS+L0/L1L0 algorithm.</span>

<span class="sd">    feature_list : list of strings</span>
<span class="sd">        List of feature names. Needs to be in the same order as the feature vectors (columns) in D.</span>
<span class="sd">        Features must consist of strings which are in F_unit (See above).</span>

<span class="sd">    feature_unit_classes : None or {list integers or the string: &#39;no_unit&#39;}</span>
<span class="sd">        integers correspond to the unit class of the features from feature_list. &#39;no_unit&#39; is reserved for</span>
<span class="sd">        dimensionless unit.</span>

<span class="sd">    output_log_file : string</span>
<span class="sd">        file path for the logger output.</span>

<span class="sd">    rm_existing_files : bool</span>
<span class="sd">        If SIS_input_path on local or remote machine (remote_input_path) exists, it is removed.</span>
<span class="sd">        Otherwise it is renamed to SIS_input_path_$number.</span>

<span class="sd">    control : dict of dicts (of dicts)</span>
<span class="sd">        Dict tree: {</span>
<span class="sd">            &#39;local_paths&#39;: { &#39;local_path&#39;:str, &#39;SIS_input_folder_name&#39;:str},</span>
<span class="sd">            (&#39;local_run&#39;,&#39;remote_run&#39;)  : (</span>
<span class="sd">                {&#39;SIS_code_path&#39;:str, &#39;mpi_command&#39;:str},</span>
<span class="sd">                {&#39;SIS_code_path&#39;:str, &#39;username&#39;:str, &#39;hostname&#39;:str, &#39;remote_path&#39;:str, &#39;eos&#39;:bool, &#39;mpi_command&#39;:str, &#39;nodes&#39;:int, (&#39;key_file&#39;, &#39;password&#39;):(str,str)}</span>
<span class="sd">            ),</span>
<span class="sd">            &#39;parameters&#39; : {&#39;n_comb&#39;:int, &#39;n_sis&#39;:int, &#39;max_dim&#39;:int, &#39;OP_list&#39;:list},</span>
<span class="sd">            &#39;advanced_parameters&#39; : {&#39;FC&#39;:FC_dic,&#39;DI&#39;:DI_dic, &#39;FCDI&#39;:FCDI_dic}</span>
<span class="sd">        }</span>
<span class="sd">        Here the tuples (.,.) mean that one and only one of the both keys has to be set.</span>
<span class="sd">        To see forms of FC_dic, DI_dic, FCDI_dic check FC_tuplelist, DI_tuplelist and FCDI_tuplelist above in PARAMETERS REFERENCE.</span>



<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    start : -</span>
<span class="sd">        starts the code</span>

<span class="sd">    get_results :  list [max_dim] of dicts {&#39;D&#39;, &#39;coefficients&#39;, &#39;P_pred&#39;}</span>
<span class="sd">        get_results[model_dim-1][&#39;D&#39;] : pandas data frame [n_sample, model_dim+1]</span>
<span class="sd">            Descriptor matrix with the columns being algebraic combinations of the input feature matrix.</span>
<span class="sd">            Column names are thus strings of the algebraic combinations of strings of inout feature_list.</span>
<span class="sd">            Last column is full of ones corresponding to the intercept</span>

<span class="sd">        get_results[model_dim-1][&#39;coefficients&#39;] : array [model_dim+1]</span>
<span class="sd">            Optimizing coefficients.</span>

<span class="sd">        get_results[model_dim-1][&#39;P_pred&#39;] : array [m_sample]</span>
<span class="sd">            Fit : np.dot( np.array(D), coefficients)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    For remote_run the library nomad_sim.ssh_code is needed. If remote machine is eos,</span>
<span class="sd">    in dict control[&#39;remote_run&#39;] the (key:value) &#39;eos&#39;:True has to be set. Then set</span>
<span class="sd">    for example in addition &#39;nodes&#39;:1 and &#39;mpi_run -np 32&#39; can be set.</span>

<span class="sd">    Paths (say name: path) are all set in the intialization part with self.path and</span>
<span class="sd">    used in other functions with self.path. In general the other variables are directly</span>
<span class="sd">    passed as arguements to the functions. There are a few exceptions as self.ssh.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    # &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    # &gt;&gt;&gt; from nomad_sim.SIS import SIS</span>
<span class="sd">    # &gt;&gt;&gt; ### Specify where on local machine input files for the SIS fortran code shall be created</span>
<span class="sd">    # &gt;&gt;&gt; Local_paths = {</span>
<span class="sd">    # &gt;&gt;&gt; &#39;local_path&#39; : &#39;/home/beaker/&#39;,</span>
<span class="sd">    # &gt;&gt;&gt; &#39;SIS_input_folder_name&#39; : &#39;SIS_input&#39;,</span>
<span class="sd">    # &gt;&gt;&gt; }</span>
<span class="sd">    # &gt;&gt;&gt; # Information for ssh connection. Instead of password also &#39;key_file&#39; for rsa key</span>
<span class="sd">    # &gt;&gt;&gt; # file path is possible.</span>
<span class="sd">    # &gt;&gt;&gt; Remote_run = {</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;mpi_command&#39;:&#39;&#39;,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;remote_path&#39; : &#39;/home/username/&#39;,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;SIS_code_path&#39; : &#39;/home/username/SIS_code/&#39;,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;hostname&#39; :&#39;hostname&#39;,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;username&#39; : &#39;username&#39;,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;password&#39; : &#39;XXX&#39;</span>
<span class="sd">    # &gt;&gt;&gt; }</span>
<span class="sd">    # &gt;&gt;&gt; # Parameters for the SIS fortran code. If at each iteration a different &#39;OP_list&#39;</span>
<span class="sd">    # &gt;&gt;&gt; # shall be used, set a list of max_dim lists, e.g. [ [&#39;+&#39;,&#39;-&#39;,&#39;*&#39;], [&#39;/&#39;,&#39;*&#39;] ], if</span>
<span class="sd">    # &gt;&gt;&gt; # n_comb = 2</span>
<span class="sd">    # &gt;&gt;&gt; Parameters = {</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;n_comb&#39; : 2,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;OP_list&#39; : [&#39;+&#39;,&#39;|-|&#39;,&#39;-&#39;,&#39;*&#39;,&#39;/&#39;,&#39;exp&#39;,&#39;^2&#39;],</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;max_dim&#39; : 2,</span>
<span class="sd">    # &gt;&gt;&gt;     &#39;n_sis&#39; : 10</span>
<span class="sd">    # &gt;&gt;&gt; }</span>
<span class="sd">    # &gt;&gt;&gt; # Final control dict for the SIS class. Instead of remote_run also local_run can be set</span>
<span class="sd">    # &gt;&gt;&gt; # (with different keys). Also advanced_parameters can be set, but should be done only</span>
<span class="sd">    # &gt;&gt;&gt; # if the parameters of the SIS fortran code are understood.</span>
<span class="sd">    # &gt;&gt;&gt; SIS_control = {&#39;local_paths&#39;:Local_paths, &#39;remote_run&#39;:Remote_run, &#39;parameters&#39;:Parameters}</span>
<span class="sd">    # &gt;&gt;&gt; # Target (label) vector P , feature_list, feature matrix D. The values are made up.</span>
<span class="sd">    # &gt;&gt;&gt; P = np.array( [1,2,3,-2,-9] )</span>
<span class="sd">    # &gt;&gt;&gt; feature_list=[&#39;r_p(A)&#39;,&#39;r_p(B)&#39;, &#39;Z(A)&#39;]</span>
<span class="sd">    # &gt;&gt;&gt; D = np.array([[7,-11,3],</span>
<span class="sd">    # &gt;&gt;&gt;              [-1,-2,4],</span>
<span class="sd">    # &gt;&gt;&gt;              [2,20,3],</span>
<span class="sd">    # &gt;&gt;&gt;              [8,1,8],</span>
<span class="sd">    # &gt;&gt;&gt;              [-3,4,1]])</span>
<span class="sd">    # &gt;&gt;&gt; # Use the code</span>
<span class="sd">    # &gt;&gt;&gt; sis = SIS(P,D,feature_list, control = SIS_control, output_log_file =&#39;/home/ahmetcik/codes/beaker/output.log&#39;)</span>
<span class="sd">    # &gt;&gt;&gt; sis.start()</span>
<span class="sd">    # &gt;&gt;&gt; results = sis.get_results()</span>
<span class="sd">    # &gt;&gt;&gt;</span>
<span class="sd">    # &gt;&gt;&gt; coef_1dim = results[0][&#39;coefficients&#39;]</span>
<span class="sd">    # &gt;&gt;&gt; coef_2dim = results[1][&#39;coefficients&#39;]</span>
<span class="sd">    # &gt;&gt;&gt; D_1dim = results[0][&#39;D&#39;]</span>
<span class="sd">    # &gt;&gt;&gt; D_2dim = results[1][&#39;D&#39;]</span>
<span class="sd">    # &gt;&gt;&gt; print coef_2dim</span>
<span class="sd">    # [-3.1514 -5.9171  3.9697]</span>
<span class="sd">    # &gt;&gt;&gt;</span>
<span class="sd">    # &gt;&gt;&gt; print D_2dim</span>
<span class="sd">    #    ((rp(B)/Z(A))/(rp(A)+rp(B)))  ((Z(A)/rp(B))/(rp(B)*Z(A)))  intercept</span>
<span class="sd">    # 0                      0.916670                     0.008264        1.0</span>
<span class="sd">    # 1                      0.166670                     0.250000        1.0</span>
<span class="sd">    # 2                      0.303030                     0.002500        1.0</span>
<span class="sd">    # 3                      0.013889                     1.000000        1.0</span>
<span class="sd">    # 4                      4.000000                     0.062500        1.0</span>
<span class="sd">    #</span>
<span class="sd">    # &quot;&quot;&quot;</span>

<span class="c1"># START INIT</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_unit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">output_log_file</span><span class="o">=</span><span class="s1">&#39;/home/beaker/.beaker/v1/web/tmp/output.log&#39;</span><span class="p">,</span> <span class="n">rm_existing_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_only_control</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">control</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_existing_files</span> <span class="o">=</span> <span class="n">rm_existing_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_unit</span> <span class="o">=</span> <span class="n">target_unit</span>
     <span class="c1">#   set_logger(output_log_file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span> <span class="o">=</span> <span class="n">if_print</span>

        <span class="c1"># Check inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_arrays</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="p">,</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;ptype&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_control</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">control_ref</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_quali_dim</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_OP_list</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_only_control</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Distribute the control keys to the corresponding init functions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_main_settings</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">control</span><span class="p">[</span><span class="s1">&#39;local_paths&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;remote_run&#39;</span> <span class="ow">in</span> <span class="n">control</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ssh_connection</span><span class="p">(</span><span class="o">**</span><span class="n">control</span><span class="p">[</span><span class="s1">&#39;remote_run&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_local_run</span><span class="p">(</span><span class="o">**</span><span class="n">control</span><span class="p">[</span><span class="s1">&#39;local_run&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;advanced_parameters&#39;</span> <span class="ow">in</span> <span class="n">control</span><span class="p">:</span>
            <span class="n">advanced_parameters</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;advanced_parameters&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">advanced_parameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_SIS_parameters</span><span class="p">(</span><span class="n">advanced_parameters</span><span class="o">=</span><span class="n">advanced_parameters</span><span class="p">,</span> <span class="o">**</span><span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predicted_feature_space_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l0_steps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checking_expense</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_close_ssh</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimate_calculation_expense</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checking_expense</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span> <span class="o">=</span> <span class="n">if_print</span>
        <span class="k">if</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">if_close_ssh</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SIS.set_main_settings"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.set_main_settings">[docs]</a>    <span class="k">def</span> <span class="nf">set_main_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="p">,</span>
                          <span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;/home/beaker/&#39;</span><span class="p">,</span> <span class="n">SIS_input_folder_name</span><span class="o">=</span><span class="s1">&#39;input_folder&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set local environment and P, D and feature_list.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_folder_name</span> <span class="o">=</span> <span class="n">SIS_input_folder_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">SIS_input_folder_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feature_unit_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_unit_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">]</span>

        <span class="c1"># Bring feature_list and D in the feature_order of F_unit becauese self.check_feature_untis needs it.</span>
        <span class="n">ordered_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_unit_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_unit_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ordered_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ordered_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">ordered_indices</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_connection</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_run</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SIS.set_local_run"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.set_local_run">[docs]</a>    <span class="k">def</span> <span class="nf">set_local_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SIS_code_path</span><span class="o">=</span><span class="s1">&#39;~/codes/SIS_code/&#39;</span><span class="p">,</span> <span class="n">mpi_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set and check local enviroment if local_run is used.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_run</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span> <span class="o">=</span> <span class="n">SIS_code_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_FCDI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">,</span> <span class="s1">&#39;FCDI&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="o">=</span> <span class="n">mpi_command</span>

        <span class="c1"># Check if SIS_code_path exists and if the SIS codes FC, DI and FCDI exist in it.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">program</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FCDI&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;DI&#39;</span><span class="p">]:</span>
                <span class="n">program_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">program_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;No executable: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">program_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;No such directory: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.set_ssh_connection"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.set_ssh_connection">[docs]</a>    <span class="k">def</span> <span class="nf">set_ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">remote_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SIS_code_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set ssh connection. Set and check remote enviroment if remote_run is used.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_connection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># weather close ssh connection at the end of do_transfer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_close_ssh</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">remote_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span> <span class="o">=</span> <span class="n">SIS_code_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_FCDI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">,</span> <span class="s1">&#39;FCDI&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_folder_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="o">=</span> <span class="n">mpi_command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eos</span> <span class="o">=</span> <span class="n">eos</span>

        <span class="n">key_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_</span><span class="p">(</span><span class="n">key_file</span><span class="p">)</span>

        <span class="c1"># set ssh connection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span> <span class="o">=</span> <span class="n">SSH</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="n">key_file</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ssh connection failed. The error message:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set number of CPUs for job submission script.</span>
        <span class="k">if</span> <span class="n">eos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CPUs</span> <span class="o">=</span> <span class="n">nodes</span> <span class="o">*</span> <span class="mi">32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Further remote machines... Now only eos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CPUs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check paths on remote machine</span>
        <span class="c1"># Check if SIS_code_path exists and if the SIS codes FC, DI and FCDI exist in it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">program</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FCDI&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;DI&#39;</span><span class="p">]:</span>
                <span class="n">program_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">program_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;No such executable on remote machine: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">program_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;No such directory on remote machine: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;No such directory on remote machine: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.set_SIS_parameters"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.set_SIS_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_SIS_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subs_sis</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rung</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">opset</span><span class="o">=</span><span class="p">[</span>
                           <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;^2&#39;</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">],</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;quanti&#39;</span><span class="p">,</span> <span class="n">advanced_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the SIS fortran code parameters</span>

<span class="sd">        If advanced parameters is passed, they will be used, otherwise default values will be used.</span>
<span class="sd">        Also max_dim, n_sis, n_comb, and OP_list can be overwritten by advanced_parameters if specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get units. It is a list of strings, e.g. [&#39;(1:4)&#39;,&#39;(5:8)&#39;,...], specifiying which columns/features of D</span>
        <span class="c1"># belong to a unit class. Index starts with 1. The columns/features were ordered in self.set_main_settings</span>
        <span class="c1"># such that columns/features of same unit are next to each other.</span>
        <span class="n">units_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_feature_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_unit_classes</span><span class="p">)</span>
        <span class="n">ndimtype</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_list</span><span class="p">)</span>
        <span class="n">nsf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_list</span><span class="p">)</span>

        <span class="c1"># self.set_par will use it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_parameters</span> <span class="o">=</span> <span class="n">advanced_parameters</span>

        <span class="c1"># Get shape of P</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="n">row_lengths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
            <span class="n">row_lengths</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">current_class</span><span class="p">])</span> <span class="k">for</span> <span class="n">current_class</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">])</span>

        <span class="c1"># initilize SIS parameters: self.parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">Param_key_list</span><span class="p">)</span>
        <span class="c1"># set parameters</span>
        <span class="c1"># FCDI</span>
        <span class="c1"># code will be run by: mpiname codename. set mpiname=&#39;&#39; for serial run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mpiname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_dim</span>           <span class="c1"># ending iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptype</span>              <span class="c1"># property type: &#39;quanti&#39;(quantitative),&#39;quali&#39;(qualitative)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># number of tasks (properties)</span>
        <span class="c1"># number of samples for each task (and group for classification, e.g. (4,3,5),(7,9) )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nsample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>                 <span class="c1"># for classification, the boundary tolerance</span>
        <span class="c1"># FC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nsf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsf</span>  <span class="c1"># number of scalar features (i.e.: the atomic parameters)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;task_arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1c&#39;</span>  <span class="c1"># number of tasks arranged in columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rung</span>  <span class="c1"># rung of feature spaces (rounds of combination)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;opset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opset</span>  <span class="c1"># oprators(currently: (+)(-)(*)(/)(exp)(log)(^-1)(^2)(^3)(sqrt)(|-|) )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ndimtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimtype</span>  <span class="c1"># number of dimension types (for dimension analysis)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dimclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units_list</span>        <span class="c1"># specify features in each class denoted by ( )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;allele&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Should all elements appear in each of the selected features?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nele&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of element (&lt;=6): useful only when symm=.true. and/or allele=.true.</span>
        <span class="c1"># features having the max. abs. data value &lt;maxfval_lb will not be selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;maxfval_lb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="c1"># features having the max. abs. data value &gt;maxfval_ub will not be selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;maxfval_ub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs_sis</span>  <span class="c1"># total number of features selected by sure independent screen</span>
        <span class="c1"># DI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;L0&#39;</span>  <span class="c1"># &#39;L1L0&#39; or &#39;L0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;size_fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># number of total features in each taskxxx.dat (same for all)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nfL0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># number of features for L0(ntotf-&gt;nfL0 if nfL0&gt;ntotf)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LS_RMSE&#39;</span>           <span class="c1"># metric for the evaluation: LS_RMSE,CV_RMSE,CV_MAE</span>
        <span class="c1"># number of top models (based on fitting) to be evaluated by the metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;n_eval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;CV_fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># k-fold CV (&gt;=2)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;CV_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># repeated k-fold CV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;n_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>                  <span class="c1"># number of top models to be output, off when =0</span>

        <span class="c1"># overwrite parameter values if specified in advanced_parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">advanced_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">advanced_parameters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<span class="c1"># END INIT</span>

<div class="viewcode-block" id="SIS.start"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Attribute which starts the calculations after init. &quot;&quot;&quot;</span>
        <span class="c1"># Check if folders exists. If yes delete (if self.rm_existing_files)</span>
        <span class="c1"># or rename it to self.SIS_input_path_old_#</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory </span><span class="si">%s</span><span class="s1"> already exists.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_existing_files</span><span class="p">:</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;It is removed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
                    <span class="n">old_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_old_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_name</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">old_name</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;It is renamed to </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">old_name</span><span class="p">)</span>
        <span class="c1"># creat input folder on local machine</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>

        <span class="c1"># write input files in inputfolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_P_D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_parameters</span><span class="p">()</span>

        <span class="c1"># decide if calculation on local or remote machine</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_transfer</span><span class="p">(</span><span class="n">ssh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="p">,</span> <span class="n">eos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eos</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">CPUs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CPUs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate on local machine. (At the moment not clear if python blocks parallel computing)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
            <span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_FCDI</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>

<div class="viewcode-block" id="SIS.set_logger"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.set_logger">[docs]</a>    <span class="k">def</span> <span class="nf">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_log_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set logger for outputs as errors, warnings, infos. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">hdlr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">output_log_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">FORMAT</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">hdlr</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">hdlr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span></div>


<span class="c1"># START ckecking functions before calculations</span>
<div class="viewcode-block" id="SIS.check_arrays"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">check_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P_in</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check arrays/list P, D and feature_list&quot;&quot;&quot;</span>

        <span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_in</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="n">P_shape</span><span class="p">,</span> <span class="n">D_shape</span><span class="p">,</span> <span class="n">f_shape</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">feature_list</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">D_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Dimension of feature matrix is </span><span class="si">%s</span><span class="s1">. A two-dimensional list or array is needed.&#39;</span> <span class="o">%</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">D_shape</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Dimension of feature list is </span><span class="si">%s</span><span class="s1">. A one-dimensional list or array is needed.&#39;</span> <span class="o">%</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">f_shape</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">P_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">D_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Length (</span><span class="si">%s</span><span class="s2">) of target property has to match to number of rows (</span><span class="si">%s</span><span class="s2">) of feature matrix.&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">P_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">P</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For ptype = &#39;quanti&#39;, a 1-dimensional array of floats/ints is required is required.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;quali&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">P_in</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For ptype = &#39;quali&#39;, a 1-dimensional array of ints is required is required.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">class_names</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
            <span class="n">n_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
            <span class="n">current_i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">P</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span> <span class="o">==</span> <span class="n">class_names</span><span class="p">[</span><span class="n">current_i</span><span class="p">]:</span>
                    <span class="n">current_i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">n_class</span> <span class="o">==</span> <span class="n">current_i</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For ptype = &#39;quali&#39;, the target property has to be ordered by classes:&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;first all members of the first class, next all members of the next class ...&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">D_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Length (</span><span class="si">%s</span><span class="s1">) of feature_list has to match to number of columns (</span><span class="si">%s</span><span class="s1">) of feature matrix.&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">f_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">f_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Length of feature_list is </span><span class="si">%s</span><span class="s1">. Choose at least two features.&#39;</span> <span class="o">%</span> <span class="n">f_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;feature_unit_classes&#39; must be numpy array, list or None.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="n">f_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Length of feature_unit_classes does not match length of feature_list.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">feature_unit_classes_integers</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_unit_classes</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
        <span class="n">feature_unit_classes_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_unit_classes</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f_c</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                                                             <span class="k">for</span> <span class="n">f_c</span> <span class="ow">in</span> <span class="n">feature_unit_classes_integers</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">f_c</span> <span class="o">==</span> <span class="s1">&#39;no_unit&#39;</span> <span class="k">for</span> <span class="n">f_c</span> <span class="ow">in</span> <span class="n">feature_unit_classes_strings</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;feature_unit_classes&#39; must consist of integers or the string &#39;no_unit&#39;, where each integer stands for the unit of a feature, i.e. 1:eV, 2:Angstrom. &#39;no_unit&#39; is reserved for dimensionless unit.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_control"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_control">[docs]</a>    <span class="k">def</span> <span class="nf">check_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_in</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">,</span> <span class="n">par_in_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recursive Function to check input control dict tree.</span>

<span class="sd">        If for example check_control(control,control_ref,&#39;control&#39;)</span>
<span class="sd">        function goes through dcit tree control and compares with control_ref</span>
<span class="sd">        if correct keys (mandotory, not_mandotory, typos of key string) are set</span>
<span class="sd">        and if values are of correct type or of optional list.</span>
<span class="sd">        Furthermore it gives Errors with hints what is wrong, and what is needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_in : any key</span>
<span class="sd">            if par_in is dict, then recursion.</span>

<span class="sd">        par_ref: any key</span>
<span class="sd">            Is compared to par_in, if of same time.</span>
<span class="sd">            If par_in and par_key are dict, alse keys are compared.</span>

<span class="sd">        par_in_path: string</span>
<span class="sd">            Gives the dict tree path where, when error occurs, e.g.</span>
<span class="sd">            control[key_1][key_2]... For using function from outside</span>
<span class="sd">            start with name of input dict, e.g. &#39;control&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if value_in has correct type = value_ref_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">par_in</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">,</span> <span class="n">par_in_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_in</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># check if correct keys are used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_keys</span><span class="p">(</span><span class="n">par_in</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">,</span> <span class="n">par_in_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key_in</span><span class="p">,</span> <span class="n">value_in</span> <span class="ow">in</span> <span class="n">par_in</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1"># get reference value like: dictionary[key_1][key_2] or here: par_ref[key_in]</span>
                <span class="c1"># Needed because control_ref has special form.</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_dic</span><span class="p">(</span><span class="n">par_ref</span><span class="p">,</span> <span class="p">[</span><span class="n">key_in</span><span class="p">])</span>

                <span class="c1"># recursion</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_control</span><span class="p">(</span><span class="n">value_in</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">,</span> <span class="n">par_in_path</span> <span class="o">+</span> <span class="s2">&quot;[&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">key_in</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.get_type"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_type"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_type">[docs]</a>    <span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_in</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">,</span> <span class="n">par_in_path</span><span class="p">,</span> <span class="n">if_also_none</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check type of par_in and par_ref.</span>

<span class="sd">        If par_ref is tuple, par_in must be item of par_ref:</span>
<span class="sd">        else: they must have same type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if par_ref is tuple, then only a few values are allowed. Thus just checked if</span>
        <span class="c1"># par_in is in par_ref instead of checking type.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_ref</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">par_in</span> <span class="ow">in</span> <span class="n">par_ref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must be in </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_in_path</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># check if type(par_in) = type(par_ref)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get type of par_ref. type(par_ref) is not enough, since in control_ref</span>
            <span class="c1"># strings,integers,dictionaries... AND types as &lt;int&gt;, &lt;dict&gt;, &lt;str&gt; are given.</span>
            <span class="n">ref_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">par_ref</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_in</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">if_also_none</span> <span class="ow">and</span> <span class="n">par_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must be </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_in_path</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.get_value_from_dic"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_value_from_dic">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">key_tree_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns value of the dict tree</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dictionary: dict or &#39;dict tree&#39; as control_ref</span>
<span class="sd">            dict_tree is when key is tuple of keys and value is tuple of</span>
<span class="sd">            corresponding values.</span>

<span class="sd">        key_tree_path: list of keys</span>
<span class="sd">            Must be in the correct order beginning from the top of the tree/dict.</span>

<span class="sd">        # Examples</span>
<span class="sd">        # --------</span>
<span class="sd">        # &gt;&gt;&gt; print get_value_from_dic[control_ref, [&#39;local_run&#39;,&#39;SIS_code_path&#39;]]</span>
<span class="sd">        # &lt;type &#39;str&#39;&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">value_ref</span> <span class="o">=</span> <span class="n">dictionary</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_tree_path</span><span class="p">:</span>
            <span class="n">value_ref_keys</span> <span class="o">=</span> <span class="n">value_ref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value_ref_keys</span><span class="p">:</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="n">value_ref</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">value_ref_keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">select_tuple</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tuples</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">select_tuple</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">key_tuple</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="n">value_ref</span><span class="p">[</span><span class="n">select_tuple</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value_ref</span></div>

<div class="viewcode-block" id="SIS.check_keys"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_keys">[docs]</a>    <span class="k">def</span> <span class="nf">check_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_in</span><span class="p">,</span> <span class="n">par_ref</span><span class="p">,</span> <span class="n">par_in_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compares the dicts par_in and par_ref.</span>

<span class="sd">        Collects which keys are missing (only if keys are not in not_mandotary) amd</span>
<span class="sd">                 whcih keys are not expected (if for example there is a typo).</span>
<span class="sd">        If there are missing or not expected ones, error message with missing/not expected ones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_in : dict</span>

<span class="sd">        par_ref : dict</span>

<span class="sd">        par_in_path : string</span>
<span class="sd">            Dictionary path string for error message, e.g &#39;control[key_1][key_2]&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keys_in</span><span class="p">,</span> <span class="n">keys_ref</span> <span class="o">=</span> <span class="n">par_in</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">par_ref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c1"># check if wrong keys are in keys_in</span>
        <span class="n">wrong_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_in</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">keys_ref</span><span class="p">)]</span>
        <span class="c1"># check missing keys and if exactly one of optional keys is selected</span>
        <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_ref</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">optional_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_in</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">leng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">optional_in</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leng</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The following keys are set in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_in_path</span><span class="p">,</span> <span class="n">optional_in</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Please select only one of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leng</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">not_mandotary</span><span class="p">:</span>
                    <span class="n">missing_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--one of: (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])))</span>
                    <span class="c1">#missing_keys.append((&#39;--one of:&#39;,)+key)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_in</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">not_mandotary</span><span class="p">:</span>
                <span class="n">missing_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># error message if needed</span>
        <span class="n">len_wrong</span><span class="p">,</span> <span class="n">len_missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_keys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">len_wrong</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">len_missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">len_wrong</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The following keys are not expected in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_in_path</span><span class="p">,</span> <span class="n">wrong_keys</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">len_missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The following keys are missing in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">par_in_path</span><span class="p">,</span> <span class="n">missing_keys</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_OP_list"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_OP_list">[docs]</a>    <span class="k">def</span> <span class="nf">check_OP_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks form and items of control[&#39;parameters&#39;][&#39;OP_list&#39;].</span>

<span class="sd">        control[&#39;parameters&#39;][&#39;OP_list&#39;] must be a list of operations strings</span>
<span class="sd">        or list of n_comb lists of operation strings. Furthermore if operation</span>
<span class="sd">        strings are item of available_OPs (see above) is checked.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        control : dict</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        control : with manipulated control[&#39;parameters&#39;][&#39;OP_list&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">OP_list</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;opset&#39;</span><span class="p">]</span>
        <span class="n">n_comb</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span>

        <span class="c1"># If just list of strings make list of n_comb lists</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">OPs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">OPs</span> <span class="ow">in</span> <span class="n">OP_list</span><span class="p">):</span>
            <span class="c1"># check if correct operations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_OP_strings</span><span class="p">(</span><span class="n">OP_list</span><span class="p">)</span>

            <span class="n">OP_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">OP_list</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comb</span><span class="p">)]</span>
            <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;opset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OP_list</span>
            <span class="k">return</span> <span class="n">control</span>

        <span class="c1"># If list of lists/tuples check if n_comb lists/tuples</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">OPs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">for</span> <span class="n">OPs</span> <span class="ow">in</span> <span class="n">OP_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">OP_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_comb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_OP_error</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check if correct operations</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_OP_strings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">OP_list</span><span class="p">))</span>
                <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;opset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OP_list</span>
                <span class="k">return</span> <span class="n">control</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_OP_error</span><span class="p">()</span>
        <span class="c1"># False form</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_OP_error</span><span class="p">()</span></div>

<div class="viewcode-block" id="SIS.check_OP_strings"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_OP_strings">[docs]</a>    <span class="k">def</span> <span class="nf">check_OP_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OPs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if all items of OPs are items of available_OPs&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">op</span> <span class="ow">in</span> <span class="n">available_OPs</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Available operations: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">available_OPs</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.return_OP_error"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.return_OP_error">[docs]</a>    <span class="k">def</span> <span class="nf">return_OP_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Error message if control[&#39;parameters&#39;][&#39;OP_list&#39;] has wrong form  &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;OP_list&#39; must consist of &#39;n_comb&#39; tuples/lists of strings of operations.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The other option is that it contains only strings of operations.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Then for each iteration the same operations will be used.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_quali_dim"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_quali_dim">[docs]</a>    <span class="k">def</span> <span class="nf">check_quali_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if quali then also desc_dim=2 &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quali&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;At the moment, for ptype = quali only desc_dim = 2 allowed &quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_">[docs]</a>    <span class="k">def</span> <span class="nf">check_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_to_maxcpu_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;/home/keys/Q8E8RS2hj441kaFaLFHSY678g2rgF20f&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># hands-on-CS</span>
                                  <span class="s2">&quot;/home/keys/Kucn93hf1F0F38aypq5fD63n7XhDyOP0&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>  <span class="c1"># sis-tutorial metal-nonmetal</span>
                                  <span class="s2">&quot;/home/keys/4Sofj9D3I1kc03E39k1fIPO9w9A03N5Z&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># sis-tutorial binaries</span>
                                  <span class="s2">&quot;/home/keys/Zn98Li73k39h5Bd0a12eq344ba3maye3&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>  <span class="c1"># sis-tutorial topological insulators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kkey</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_maxcpu_dic</span><span class="p">:</span>
            <span class="n">max_cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_maxcpu_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">&quot;key.mpi&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">for_me</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_cpu</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span><span class="o">.</span><span class="n">isspace</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx_n_cpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">&gt;</span> <span class="n">max_cpu</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="n">max_cpu</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;For your pupose, the maximum allowed CPU number is </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">max_cpu</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span><span class="p">[</span><span class="n">idx_n_cpu</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The calculations are running on </span><span class="si">%s</span><span class="s2"> CPUs.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mpi_command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MPI command not known. The calculations are restricted to run on only one CPU.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">k</span></div>

    <span class="c1"># feature space estimation</span>

<div class="viewcode-block" id="SIS.ncr"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.ncr">[docs]</a>    <span class="k">def</span> <span class="nf">ncr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Binomial coefficient&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">numer</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">opop</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">opop</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">numer</span> <span class="o">//</span> <span class="n">denom</span></div>

<div class="viewcode-block" id="SIS.check_l0_steps"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_l0_steps">[docs]</a>    <span class="k">def</span> <span class="nf">check_l0_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">n_sis</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if number of l0 steps is larger then a upper_limit&quot;&quot;&quot;</span>
        <span class="n">l0_steps_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncr</span><span class="p">(</span><span class="n">n_sis</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">l0_steps</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">l0_steps_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l0_steps</span> <span class="o">=</span> <span class="n">l0_steps</span>

        <span class="k">if</span> <span class="n">l0_steps</span> <span class="o">&gt;</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;With the given settings in the l0-regularizaton </span><span class="si">%s</span><span class="s2"> combinations of features have to be considered.&quot;</span> <span class="o">%</span>
                <span class="n">l0_steps</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;In this version the upper limit for ptype = &#39;</span><span class="si">%s</span><span class="s2">&#39; is </span><span class="si">%s</span><span class="s2">*n_CPUs. Choose a smaller&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ptype&#39;</span><span class="p">],</span> <span class="n">upper_limit</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;Optimal descriptor maximum dimension&#39; or &#39;Number of collected features per SIS iteration&#39;&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.get_next_size"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_next_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_next_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="n">new_features</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">un_OP</span><span class="p">:</span>
                <span class="n">new_features</span> <span class="o">+=</span> <span class="n">n_features</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bin_OP</span><span class="p">:</span>
                <span class="n">new_features</span> <span class="o">+=</span> <span class="n">n_features</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_features</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncr</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_features</span> <span class="o">+</span> <span class="n">n_features</span></div>

<div class="viewcode-block" id="SIS.estimate_feature_space"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.estimate_feature_space">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_feature_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_comb</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">n_comb_start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="p">[</span><span class="n">rate</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comb</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comb_start</span><span class="p">,</span> <span class="n">n_comb</span><span class="p">):</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_next_size</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.check_feature_space_size"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_feature_space_size">[docs]</a>    <span class="k">def</span> <span class="nf">check_feature_space_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">n_target</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="mi">300000000</span><span class="p">):</span>
        <span class="n">n_comb</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">])</span>
        <span class="n">max_dim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">])</span>
        <span class="n">n_sis</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">OP_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;opset&#39;</span><span class="p">]</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_target</span><span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_target</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)))</span>

        <span class="c1"># make sis calculation to obtain self.featurespace(rung=2) for feature_space estimation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
        <span class="n">feature_space_size_ncomb2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span>

        <span class="c1"># set parameters back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_comb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sis</span>

        <span class="n">estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_feature_space</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">feature_space_size_ncomb2</span><span class="p">,</span> <span class="n">OP_list</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">n_comb_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicted_feature_space_size</span> <span class="o">=</span> <span class="n">estimate</span>

        <span class="k">if</span> <span class="n">estimate</span> <span class="o">*</span> <span class="n">max_dim</span> <span class="o">&gt;</span> <span class="n">upper_bound</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">:</span>
            <span class="n">digit_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">estimate</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Estimated order of magnitude of feature space size: 10^</span><span class="si">%s</span><span class="s2"> - 10^</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">digit_len</span><span class="p">,</span> <span class="n">digit_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In this version the upper bound for n_features is given by:&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &gt; n_features*max_dim/n_CPUs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upper_bound</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Hint: select less primary features, less operations or a smaller max_dim.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The registered user will be allowed soon to use larger feature spaces.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.estimate_calculation_expense"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.estimate_calculation_expense">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_calculation_expense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check the expense of the SIS+l0 calculations&quot;&quot;&quot;</span>
        <span class="n">n_target</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_target</span><span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_target</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)))</span>

        <span class="n">max_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span>
        <span class="n">n_sis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span>
        <span class="n">n_comb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span>

        <span class="c1"># check l0 steps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_l0_steps</span><span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">n_sis</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="mi">1100000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u_l</span> <span class="o">=</span> <span class="mi">180000</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kkey</span> <span class="ow">in</span> <span class="s2">&quot;/home/keys/Zn98Li73k39h5Bd0a12eq344ba3maye3&quot;</span><span class="p">:</span>  <span class="c1"># topological insulator</span>
                <span class="n">u_l</span> <span class="o">/=</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kkey</span> <span class="ow">in</span> <span class="s2">&quot;/home/keys/Kucn93hf1F0F38aypq5fD63n7XhDyOP0&quot;</span><span class="p">:</span>  <span class="c1"># metal-nonmetal</span>
                <span class="n">u_l</span> <span class="o">=</span> <span class="mi">1150000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_l0_steps</span><span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">n_sis</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="n">u_l</span><span class="p">)</span>

        <span class="c1"># check feature spcae</span>
        <span class="k">if</span> <span class="n">n_comb</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kkey</span> <span class="ow">in</span> <span class="s2">&quot;/home/keys/Zn98Li73k39h5Bd0a12eq344ba3maye3&quot;</span><span class="p">:</span>  <span class="c1"># topological insulator</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;A &#39;number of iterations for the construction for the feature space&#39; &gt; 2 is not allowed for this tutorial.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="n">u_l</span> <span class="o">=</span> <span class="mi">4460000</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kkey</span> <span class="ow">in</span> <span class="s2">&quot;/home/keys/Kucn93hf1F0F38aypq5fD63n7XhDyOP0&quot;</span><span class="p">:</span>
                <span class="n">u_l</span> <span class="o">=</span> <span class="mi">4460000</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_feature_space_size</span><span class="p">(</span><span class="n">feature_list</span><span class="p">,</span> <span class="n">n_target</span><span class="o">=</span><span class="n">n_target</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="n">u_l</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_comb</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;A &#39;number of iterations for the construction for the feature space&#39; &gt;3 is not allowed.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># END checking functions</span>

<div class="viewcode-block" id="SIS.do_transfer"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.do_transfer">[docs]</a>    <span class="k">def</span> <span class="nf">do_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">CPUs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run the calcualtion on remote machine</span>

<span class="sd">        First checks if already folder self.remote_input_path exists on remote machine,</span>
<span class="sd">        if yes it deletes or renames it.</span>
<span class="sd">        Then copies file system self.SIS_input_path with SIS fortran code files into the</span>
<span class="sd">        folder self.remote_input_path. Finally lets run the calculations on remote machine</span>
<span class="sd">        and copy back the file system with results.</span>
<span class="sd">        If eos, writes submission script, submits script and checks qstat if calculation</span>
<span class="sd">        finished.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ssh : object</span>
<span class="sd">            Must be from code nomad_sim.ssh_code.</span>

<span class="sd">        eos : bool</span>
<span class="sd">            If remote machine is eos. To write submission script and submit ...</span>

<span class="sd">        username: string</span>
<span class="sd">            needed to check qstat on eos</span>

<span class="sd">        CPUs : int</span>
<span class="sd">            To reserve the write number of CPUs in the eos submission script</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if remote_input_path exists and if yes rename it to remote_input_path_old_#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory </span><span class="si">%s</span><span class="s1"> on remote machine already exists.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_existing_files</span><span class="p">:</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;It is removed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
                    <span class="n">old_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_old_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_name</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">,</span> <span class="n">old_name</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;It is renamed to </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">old_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_submission_script</span><span class="p">(</span><span class="n">CPUs</span><span class="p">)</span>

        <span class="c1"># copy self.SIS_input_path INto self.remote_path</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">put_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eos</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># submit job called go.sge</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">%s</span><span class="s2">; qsub go.sge&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SCHEDule</span> <span class="o">=</span> <span class="n">sched</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">)</span>

            <span class="c1"># check each seconds if is job is finished</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SCHEDule</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_periodically</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SCHEDule</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SCHEDule</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># execute SIS_code on remote machine</span>
            <span class="c1"># exporting path is needed, since code FCDI calls the codes FC and DI by just &#39;FC&#39; and &#39;DI&#39;.</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;export PATH=$PATH:</span><span class="si">%s</span><span class="s1">; cd </span><span class="si">%s</span><span class="s1">; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIS_code_FCDI</span><span class="p">))</span>

        <span class="c1"># copy back file system with results</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">)</span>
        <span class="c1"># close ssh connection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_close_ssh</span><span class="p">:</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SIS.check_status"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if calculation on eos is finished</span>

<span class="sd">        Parameters</span>
<span class="sd">        filename: str</span>
<span class="sd">            qstat will be written into this file. The file will be then read.</span>

<span class="sd">        username: str</span>
<span class="sd">            search in filename for this username. If not appears calculation is finished.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : bool</span>
<span class="sd">            True if calculations is still running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># write qstat into filenmae</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;qstat -u </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># read filename</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># if job name SIS_tutori (only 10 char) and username appears</span>
                <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SIS_tutori&#39;</span> <span class="ow">and</span> <span class="n">split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="SIS.ask_periodically"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.ask_periodically">[docs]</a>    <span class="k">def</span> <span class="nf">ask_periodically</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recursive function that runs periodically (each seconds) the</span>
<span class="sd">            function self.check_status.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_input_path</span><span class="p">,</span> <span class="s1">&#39;status.dat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SCHEDule</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_periodically</span><span class="p">,</span> <span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span></div>

<div class="viewcode-block" id="SIS.write_submission_script"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.write_submission_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_submission_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CPUs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; writes eos job submission script. &quot;&quot;&quot;</span>

        <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#$ -S /bin/bash&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#$ -j n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#$ -N SIS_tutorial&quot;</span><span class="p">,</span>  <span class="c1"># jobname</span>
            <span class="s2">&quot;#$ -cwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#$ -m n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#$ -pe impi_hydra </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">CPUs</span><span class="p">,</span>  <span class="c1"># CPUs= nodes*32!</span>
            <span class="s2">&quot;#$ -l h_rt=00:01:00&quot;</span><span class="p">,</span>  <span class="c1"># time reservation for job</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SIS_code_FCDI</span>
        <span class="p">]</span>
        <span class="c1"># write submission file &quot;go.sge&quot;</span>
        <span class="n">submission_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="s1">&#39;go.sge&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
            <span class="n">submission_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">submission_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SIS.check_feature_units"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_feature_units">[docs]</a>    <span class="k">def</span> <span class="nf">check_feature_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_unit_classes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check feature units</span>

<span class="sd">        Checks which</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        feature_unit_classes : list integers</span>
<span class="sd">            list must be sorted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unit_strings : list of strings</span>
<span class="sd">            In the form [&#39;(1:3)&#39;,&#39;(4:8)&#39;,..], where the indices start from 1,</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_unit_classes</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_unit_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">unit_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_names</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">feature_unit_classes</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">cl</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cl</span> <span class="o">!=</span> <span class="s1">&#39;no_unit&#39;</span><span class="p">:</span>
                <span class="n">unit_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">unit_strings</span></div>

<div class="viewcode-block" id="SIS.convert_feature_strings"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.convert_feature_strings">[docs]</a>    <span class="k">def</span> <span class="nf">convert_feature_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Convert feature strings.</span>

<span class="sd">        Puts an &#39;sr&#39; for reals and an &#39;si&#39; for integers at the beginning of a string.</span>
<span class="sd">        Returns the list with the changed strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">reals</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Developer error: </span><span class="si">%s</span><span class="s2"> not found in the list reals or ints.&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">standard_2_converted</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;s</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">converted</span></div>

<div class="viewcode-block" id="SIS.write_parameters"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.write_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">write_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write parameters into the SIS fortran code input files. Convert the parameters into</span>
<span class="sd">            the special format before.&quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;FCDI.in&#39;</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># loop in correct order as in Param_key_list could be essential. So better no iteritems()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Param_key_list</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_2_fortran</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">input_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SIS.convert_2_fortran"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.convert_2_fortran">[docs]</a>    <span class="k">def</span> <span class="nf">convert_2_fortran</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">parameter_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert parameters to SIS fortran code style.</span>

<span class="sd">            Converts e.g. True to string &#39;.true.&#39; or a string &#39;s&#39; to</span>
<span class="sd">            &quot;&#39;s&#39;&quot;, and other special formats.</span>
<span class="sd">            Returns the converted parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s1">&#39;opset&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_OPs</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s1">&#39;dimclass&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parameter_value</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;.true.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;.false.&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">parameter_value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">parameter_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parameter_value</span></div>

<div class="viewcode-block" id="SIS.get_OPs"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_OPs">[docs]</a>    <span class="k">def</span> <span class="nf">get_OPs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conver OP_list to special format for SIS fortran input.&quot;&quot;&quot;</span>

        <span class="n">list_of_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">OPs</span> <span class="ow">in</span> <span class="n">OP_list</span><span class="p">:</span>
            <span class="c1"># convert OP_list: in example [&#39;+&#39;, &#39;-&#39;, &#39;/&#39;, &#39;^2&#39;, &#39;exp&#39;] to &#39;(+)(-)(/)(^2)(exp)&#39;</span>
            <span class="n">OP_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPs</span><span class="p">:</span>
                <span class="n">OP_string</span> <span class="o">+=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">op</span>
            <span class="n">list_of_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">OP_string</span><span class="p">)</span>

        <span class="c1"># make string of OP_string listed ncomb times e.g. &quot;&#39;(+)(-)(/)(^2)(exp)&#39;,&#39;(+)(-)(/)(^2)(exp)&#39;,...&quot;</span>
        <span class="n">converted</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_strings</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">converted</span></div>

<div class="viewcode-block" id="SIS.flatten"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.flatten">[docs]</a>    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the list_in collapsed into a one dimensional list</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            list_in : list/tuple of lists/tuples of ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list_in</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">list_out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">list_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_out</span></div>

<div class="viewcode-block" id="SIS.write_P_D"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.write_P_D">[docs]</a>    <span class="k">def</span> <span class="nf">write_P_D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes &#39;train.dat&#39; as SIS fortran code input with P, D and feature strings&quot;&quot;&quot;</span>

        <span class="c1">#converted_features = self.convert_feature_strings(feature_list)</span>
        <span class="n">converted_features</span> <span class="o">=</span> <span class="n">feature_list</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">P_shape</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">P_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(([</span><span class="s1">&#39;xxx&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">))],</span> <span class="n">P</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entries_of_P</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">entries_of_P</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">]</span>

        <span class="n">first_line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">converted_features</span><span class="p">)</span>

        <span class="n">Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
        <span class="n">Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">first_line</span><span class="p">,</span> <span class="n">Out</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="s2">&quot;train.dat&quot;</span><span class="p">),</span> <span class="n">Out</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SIS.get_des"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_des">[docs]</a>    <span class="k">def</span> <span class="nf">get_des</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change the descriptor strings read from the output DI.out.</span>
<span class="sd">        Remove characters as &#39;:&#39; &#39;si&#39;, &#39;sr&#39;. Then convert feature strings for printing&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">n_i</span> <span class="k">for</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">remove_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">n_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">n_i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                        <span class="n">remove_index</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_i</span><span class="p">,</span> <span class="n">n_i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remove_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_string</span></div>

<div class="viewcode-block" id="SIS.check_FC"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_FC">[docs]</a>    <span class="k">def</span> <span class="nf">check_FC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check FC.out, if calculation has finished and feature space_sizes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        calc_finished : bool</span>
<span class="sd">            If calculation finished there shoul be a &#39;Have a nice day !&#39;.</span>

<span class="sd">        featurespace : integer</span>
<span class="sd">            Total feature space size generated, before the redundant check.</span>

<span class="sd">        n_collected : integer</span>
<span class="sd">            The number of features collected in the current iteration.</span>
<span class="sd">            Should be n_sis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">featurespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_collected</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">calc_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">feature_space_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;Total Featurespace:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">feature_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;Have a nice day !&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">calc_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;Final feature space size:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">n_collected</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">calc_finished</span><span class="p">,</span> <span class="n">feature_space_list</span><span class="p">,</span> <span class="n">n_collected</span></div>

<div class="viewcode-block" id="SIS.check_DI"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_DI">[docs]</a>    <span class="k">def</span> <span class="nf">check_DI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check DI.out, if calculation has finished. &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">calc_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;Have a nice day !&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">calc_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">calc_finished</span></div>

<div class="viewcode-block" id="SIS.check_files"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.check_files">[docs]</a>    <span class="k">def</span> <span class="nf">check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check which file is missing and maybe why.</span>

<span class="sd">        This function, if something went wrong to find out where the problem occured.</span>
<span class="sd">        Returns an error string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">)</span>
        <span class="n">DI_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;DI.out&#39;</span><span class="p">)</span>
        <span class="n">FC_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;FC.out&#39;</span><span class="p">)</span>

        <span class="n">if_iter</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">iter_path</span><span class="p">)</span>
        <span class="n">if_FC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">FC_path</span><span class="p">)</span>
        <span class="n">if_DI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">DI_path</span><span class="p">)</span>

        <span class="n">n_sis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span>
        <span class="n">sub_space_size</span> <span class="o">=</span> <span class="n">dimension</span> <span class="o">*</span> <span class="n">n_sis</span>
        <span class="k">if</span> <span class="n">if_iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">if_FC</span><span class="p">:</span>
                <span class="n">calc_finished</span><span class="p">,</span> <span class="n">feature_space</span><span class="p">,</span> <span class="n">n_collected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_FC</span><span class="p">(</span><span class="n">FC_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_finished</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;FC.out not finished&#39;</span>
                <span class="k">if</span> <span class="n">feature_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&#39;Total Featurespace&#39; not found&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;FC.out not found&#39;</span>

            <span class="k">if</span> <span class="n">n_collected</span> <span class="o">&lt;</span> <span class="n">n_sis</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;No </span><span class="si">%s</span><span class="s1">D descriptor!</span><span class="se">\n</span><span class="s1">The number of collected feateres in iteration </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">. Probably the total feature space size is not large enough. Collect less features per iteration.</span><span class="se">\n</span><span class="s1">Total feature space size before redundant check: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">      Target total number of collected features: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">After eliminating redundant features the total feature space becomes smaller.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">dimension</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">n_collected</span><span class="p">,</span> <span class="n">feature_space</span><span class="p">,</span> <span class="n">sub_space_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">if_DI</span><span class="p">:</span>
                <span class="n">calc_finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_DI</span><span class="p">(</span><span class="n">DI_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_finished</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;DI.out not finished&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;DI.out not found&#39;</span>

            <span class="k">return</span> <span class="s1">&#39;Unknown error&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">iter_folder_name</span></div>

<div class="viewcode-block" id="SIS.read_results"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.read_results">[docs]</a>    <span class="k">def</span> <span class="nf">read_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">tsizer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read results from DI.out.</span>


<span class="sd">        parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iter_folder : string</span>
<span class="sd">            Name of the iter_folder the outputs of the corresponding iteration of SIS+l1/l1l0,</span>
<span class="sd">            e.g. &#39;iter01&#39;, &#39;iter02&#39;.</span>

<span class="sd">        dimension : integer</span>
<span class="sd">            DI.out provides for example in iteration three 1-3 dimensionl descriptors.</span>
<span class="sd">            Here choose which dimension should be returned.</span>

<span class="sd">        task : integer &lt; 100</span>
<span class="sd">            For multi task, must be worked on.</span>

<span class="sd">        tsizer : integer</span>
<span class="sd">            Number of samples, e.g. number ofrows of D or P.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RMSE : float</span>
<span class="sd">            Root means squares error of model</span>

<span class="sd">        Des : list of strings</span>
<span class="sd">            List of the descriptors</span>

<span class="sd">        coef : array [model_dim+1]</span>
<span class="sd">            Coefficients including the intercept</span>

<span class="sd">        D : array [n_sample, model_dim+1]</span>
<span class="sd">            Matrix with columns being the selected features (descriptors) for the model.</span>
<span class="sd">            The last column is full of ones corresponding to the intercept</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">)</span>
        <span class="n">DI_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;DI.out&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">task</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">s_task</span> <span class="o">=</span> <span class="s1">&#39;0</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">task</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_task</span> <span class="o">=</span> <span class="s1">&#39;00</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">task</span>
        <span class="n">desc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;desc_dat&#39;</span><span class="p">,</span> <span class="s1">&#39;desc</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.dat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">s_task</span><span class="p">))</span>

        <span class="n">count_dim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">DI_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;@@@descriptor&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">count_dim</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">count_dim</span> <span class="o">==</span> <span class="n">dimension</span><span class="p">:</span>
                    <span class="n">des</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">Des</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_des</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">des</span><span class="p">]</span>  <span class="c1"># convert strings</span>
            <span class="k">if</span> <span class="n">count_dim</span> <span class="o">==</span> <span class="n">dimension</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;coefficients_&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;Intercept_&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">inter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">inter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;LSrmse&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">RMSE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">tsizer</span><span class="p">,</span> <span class="n">dimension</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">desc_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]):</span>
                    <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tsizer</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Des</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">D</span></div>

<div class="viewcode-block" id="SIS.get_indices_of_top_descriptors"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_indices_of_top_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">get_indices_of_top_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_path</span><span class="p">,)</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Calculation Aborted.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The Number of collected features in the SIS step might have exceeded&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;the number of features in the created feature space.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Hint: Try a smaller &#39;Number of collected features per SIS iteration&#39;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Hint: or increase the feature space size.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="c1">#filename = &quot;top%04d_02D&quot; % n_out</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">top_dat</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">Ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Overlaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">old_n_overlap</span><span class="p">,</span> <span class="n">old_overlap_area</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_dat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n_overlap</span><span class="p">,</span> <span class="n">overlap_area</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">old_n_overlap</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n_overlap</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="ow">and</span> <span class="n">old_overlap_area</span> <span class="ow">in</span> <span class="p">[</span><span class="n">overlap_area</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]]</span>
                    <span class="n">Ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="n">Overlaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_overlap</span><span class="p">)</span>
                    <span class="n">old_n_overlap</span><span class="p">,</span> <span class="n">old_overlap_area</span> <span class="o">=</span> <span class="n">n_overlap</span><span class="p">,</span> <span class="n">overlap_area</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">Overlaps</span><span class="p">,</span> <span class="n">Ind</span></div>

<div class="viewcode-block" id="SIS.manipulate_descriptor_string"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.manipulate_descriptor_string">[docs]</a>    <span class="k">def</span> <span class="nf">manipulate_descriptor_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="SIS.get_strings_of_top_descriptors"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_strings_of_top_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">get_strings_of_top_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_indices</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_path</span><span class="p">,</span> <span class="s2">&quot;task.fname&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="c1"># importan to return [1:-1] to remove brackets in string</span>
        <span class="k">return</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">manipulate_descriptor_string</span><span class="p">(</span><span class="n">descriptors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">]</span></div>

<div class="viewcode-block" id="SIS.get_arrays_of_top_descriptors"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_arrays_of_top_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">get_arrays_of_top_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_indices</span><span class="p">):</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_indices</span><span class="p">)</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_indices</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;task001.dat&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Ds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Ds</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">)]</span></div>

<div class="viewcode-block" id="SIS.read_results_quali"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.read_results_quali">[docs]</a>    <span class="k">def</span> <span class="nf">read_results_quali</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read results for 2D desriptor from calculations with qualitative run.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results: list of lists</span>
<span class="sd">            Each sublist characterizes separate model (if multiple model have same score/cost</span>
<span class="sd">            all of them are returned). Sublist contains [descriptor_strings, D, n_overlap]</span>
<span class="sd">            where D (D.shape = (n_smaple,2)) is array with descriptor vectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="s2">&quot;iter02&quot;</span><span class="p">)</span>
        <span class="n">Overlaps</span><span class="p">,</span> <span class="n">Top_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices_of_top_descriptors</span><span class="p">()</span>
        <span class="n">Top_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_strings_of_top_descriptors</span><span class="p">(</span><span class="n">Top_indices</span><span class="p">)</span>
        <span class="n">Top_Ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_arrays_of_top_descriptors</span><span class="p">(</span><span class="n">Top_indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">Top_strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Top_Ds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Overlaps</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Top_indices</span><span class="p">))]</span></div>

<div class="viewcode-block" id="SIS.string_descriptor"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.string_descriptor">[docs]</a>    <span class="k">def</span> <span class="nf">string_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">target_unit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make string for output in the terminal with model and its RMSE.&quot;&quot;&quot;</span>

        <span class="n">dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">D descriptor:</span><span class="se">\n</span><span class="s1">Root Mean Squared Error (RMSE): </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Model: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">target_unit</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimension</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dimension</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span></div>

<div class="viewcode-block" id="SIS.get_results"><a class="viewcode-back" href="../../../ai4materials.models.sis.html#ai4materials.models.sis.SIS.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ith_descriptor</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Attribute to get results from the file system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------</span>
<span class="sd">        ith_descriptor: int</span>
<span class="sd">            Return the ith best descriptor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : list [max_dim] of dicts {&#39;D&#39;, &#39;coefficients&#39;, &#39;P_pred&#39;}</span>

<span class="sd">        out[model_dim-1][&#39;D&#39;] : pandas data frame [n_sample, model_dim+1]</span>
<span class="sd">            Descriptor matrix with the columns being algebraic combinations of the input feature matrix.</span>
<span class="sd">            Column names are thus strings of the algebraic combinations of strings of inout feature_list.</span>
<span class="sd">            Last column is full of ones corresponding to the intercept</span>

<span class="sd">        out[model_dim-1][&#39;coefficients&#39;] : array [model_dim+1]</span>
<span class="sd">            Optimizing coefficients.</span>

<span class="sd">        out[model_dim-1][&#39;P_pred&#39;] : array [m_sample]</span>
<span class="sd">            Fit : np.dot( np.array(D) , coefficients)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;desc_dim&#39;</span><span class="p">]</span>
        <span class="n">Results_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tsizer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quanti&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dimension</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">iter_folder_name</span> <span class="o">=</span> <span class="s1">&#39;iter0</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iter_folder_name</span> <span class="o">=</span> <span class="s1">&#39;iter</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimension</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_results</span><span class="p">(</span><span class="n">iter_folder_name</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tsizer</span><span class="p">)</span>
                    <span class="n">Results_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">iter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">)</span>
                        <span class="n">FC_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iter_path</span><span class="p">,</span> <span class="s1">&#39;FC.out&#39;</span><span class="p">)</span>
                        <span class="c1"># feature space size</span>
                        <span class="n">feature_space_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_FC</span><span class="p">(</span><span class="n">FC_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature_space_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature_space_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_feature_space</span><span class="p">(</span>
                                    <span class="mi">3</span><span class="p">,</span> <span class="n">featurespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;opset&#39;</span><span class="p">],</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">n_comb_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Developper error: feature space estimation and rung conflict!&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span><span class="p">:</span>
                            <span class="n">digit_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featurespace</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Estimated order of magnitude of feature space size: 10^</span><span class="si">%s</span><span class="s2"> - 10^</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">digit_len</span><span class="p">,</span> <span class="n">digit_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_files</span><span class="p">(</span><span class="n">iter_folder_name</span><span class="p">,</span> <span class="n">dimension</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dimension</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;## See below the Error message:&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># print results, make pandas DataFrames and calulate predicted/fitted values</span>
            <span class="k">for</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">features_selected</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">D_model</span> <span class="ow">in</span> <span class="n">Results_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_descriptor</span><span class="p">(</span><span class="n">RMSE</span><span class="p">,</span> <span class="n">features_selected</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_unit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

                <span class="c1"># predicted/fitted values of the model</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D_model</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">)</span>

                <span class="c1"># D_model and selected features as pandas DataFrames</span>
                <span class="n">features_selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span>
                <span class="n">D_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">D_model</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">features_selected</span><span class="p">)</span>

                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="n">D_df</span><span class="p">,</span> <span class="s1">&#39;coefficients&#39;</span><span class="p">:</span> <span class="n">coefficients</span><span class="p">,</span> <span class="s1">&#39;P_pred&#39;</span><span class="p">:</span> <span class="n">fit</span><span class="p">})</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;quali&#39;. Only for specific case of 2D</span>
            <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">iter_folder_name</span> <span class="o">=</span> <span class="s1">&#39;iter0</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="n">iter_folder_name</span><span class="p">)</span>
                <span class="n">FC_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">,</span> <span class="s1">&#39;iter01&#39;</span><span class="p">,</span> <span class="s1">&#39;FC.out&#39;</span><span class="p">)</span>

                <span class="c1"># feature space size</span>
                <span class="n">feature_space_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_FC</span><span class="p">(</span><span class="n">FC_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature_space_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature_space_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_feature_space</span><span class="p">(</span>
                            <span class="mi">3</span><span class="p">,</span> <span class="n">featurespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;opset&#39;</span><span class="p">],</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">n_comb_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">featurespace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurespace</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Developper error: feature space estimation and rung conflict!&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">digit_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featurespace</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">first_digit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">featurespace</span><span class="p">,</span> <span class="o">-</span><span class="n">digit_len</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">feature_space_message</span> <span class="o">=</span> <span class="s2">&quot;Size of feature space: </span><span class="si">%s</span><span class="s2">*10^</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">first_digit</span><span class="p">,</span> <span class="n">digit_len</span><span class="p">)</span>

                <span class="c1"># get results</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checking_expense</span><span class="p">:</span>
                    <span class="n">results_list_v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_results_quali</span><span class="p">()</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>

                    <span class="n">n_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_list_v1</span><span class="p">)</span>

                    <span class="c1"># get real overlap with width=0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rung&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;subs_sis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ndimtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dimclass=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(1:1)&#39;</span><span class="p">,</span> <span class="s1">&#39;(2:2)&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nsf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mpiname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1">#self.if_print = False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Des</span><span class="p">,</span> <span class="n">D_selected</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">results_list_v1</span><span class="p">[</span><span class="n">ith_descriptor</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                        <span class="n">Des</span><span class="p">,</span> <span class="n">D_selected</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">results_list_v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D_selected</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feature_list</span> <span class="o">=</span> <span class="n">Des</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feature_unit_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">if_close_ssh</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_results_quali</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SIS_input_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_print</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SISSO CALCULATION FINISHED&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">feature_space_message</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">final_result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Angelo Ziletti.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>