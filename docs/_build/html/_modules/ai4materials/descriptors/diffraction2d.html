

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ai4materials.descriptors.diffraction2d &mdash; ai4materials v0.1.0</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="ai4materials v0.1.0" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/>
    <link href="../../../_static/nomad-analytics.css" rel="stylesheet" type="text/css">


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ai4materials
          

          
            
            <img src="../../../_static/ai_for_materials_logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.dataprocessing.html">Data preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.descriptors.html">Representing crystal structures: descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.wrappers.html">Creating and loading materials science datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.models.html">Regression and classification models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.interpretation.html">Neural network interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai4materials.utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ai4materials</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ai4materials.descriptors.diffraction2d</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ai4materials.descriptors.diffraction2d</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># coding=utf-8</span>
<span class="c1"># Copyright 2016-2019 Angelo Ziletti</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="k">import</span> <span class="n">iteritems</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Angelo Ziletti&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2016, The NOMAD Project&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Angelo Ziletti&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;ziletti@fhi-berlin.mpg.de&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;21/06/18&quot;</span>

<span class="kn">import</span> <span class="nn">condor</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">ai4materials.descriptors.base_descriptor</span> <span class="k">import</span> <span class="n">Descriptor</span>
<span class="kn">from</span> <span class="nn">ai4materials.descriptors.base_descriptor</span> <span class="k">import</span> <span class="n">is_descriptor_consistent</span>
<span class="kn">from</span> <span class="nn">ai4materials.utils.utils_crystals</span> <span class="k">import</span> <span class="n">rot_mat_x</span>
<span class="kn">from</span> <span class="nn">ai4materials.utils.utils_crystals</span> <span class="k">import</span> <span class="n">rot_mat_y</span>
<span class="kn">from</span> <span class="nn">ai4materials.utils.utils_crystals</span> <span class="k">import</span> <span class="n">rot_mat_z</span>
<span class="kn">from</span> <span class="nn">ai4materials.utils.utils_crystals</span> <span class="k">import</span> <span class="n">scale_structure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ai4materials&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Diffraction2D"><a class="viewcode-back" href="../../../ai4materials.descriptors.diffraction2d.html#ai4materials.descriptors.diffraction2d.Diffraction2D">[docs]</a><span class="k">class</span> <span class="nc">Diffraction2D</span><span class="p">(</span><span class="n">Descriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The two dimensional diffraction descriptor.</span>

<span class="sd">    This is the descriptor introduced in Ziletti et al., Nature Communications 9, 2775, (2018). The default values</span>
<span class="sd">    of the parameters used are the one used in the reference above.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    configs: dict</span>
<span class="sd">        Contains configuration information such as folders for input and output</span>
<span class="sd">        (e.g. `desc_folder`, `tmp_folder`), logging level, and metadata location.</span>
<span class="sd">        See also :py:mod:`ai4materials.utils.utils_config.set_configs`.</span>

<span class="sd">    param_source: dict, optional (default={&#39;wavelength&#39;: 5.0E-12, &#39;pulse_energy&#39;: 1E-6, &#39;focus_diameter&#39;: 1E-6})</span>
<span class="sd">        Contains parameters that are passed to the underlying package used for the diffraction computation (Condor).</span>
<span class="sd">        This parameters are passed to Condor via: \n</span>
<span class="sd">        `src = condor.Source(**self.param_source)` \n</span>
<span class="sd">        See http://condor.readthedocs.io/en/latest/config.html#source for the parameters that can be used.</span>

<span class="sd">    param_detector: dict, optional (default={&#39;distance&#39;: 0.1, &#39;pixel_size&#39;: 4E-4, &#39;nx&#39;: 64, &#39;ny&#39;: 64})</span>
<span class="sd">        Contains parameters that are passed to the underlying package used for the diffraction computation (Condor).</span>
<span class="sd">        This parameters are passed to Condor via: \n</span>
<span class="sd">        `det = condor.Detector(**self.param_detector)` \n</span>
<span class="sd">        See http://condor.readthedocs.io/en/latest/config.html#detector for the parameters that can be used.</span>

<span class="sd">    desc_angles: dict, optional (default={&quot;r&quot;: [-45., 45.], &quot;g&quot;: [-45., 45.], &quot;b&quot;: [-45., 45.]})</span>
<span class="sd">        As described in Ziletti et al., each structure is rotated clockwise and counterclockwise about a given</span>
<span class="sd">        crystal axis, the diffraction pattern for each rotation is calculated, and then the two patterns</span>
<span class="sd">        are superimposed. This procedure is then repeated for all three crystal axes.</span>
<span class="sd">        The final result is represented as one RGB image for crystal structure, where each color channel shows</span>
<span class="sd">        the diffraction patterns obtained by rotating about a given axis</span>
<span class="sd">        (red (R) for x-axis, green (G) for y-axis, and blue (B) for z-axis).</span>
<span class="sd">        For example: \n</span>
<span class="sd">        `&quot;r&quot;: [-45., 45.]` \n</span>
<span class="sd">        means that the diffraction pattern for the R channel is given by the superposition of the diffraction pattern</span>
<span class="sd">        obtained by rotating the structure around the first crystal axis clockwise and counterclockwise by 45 degrees.</span>

<span class="sd">    atoms_scaling: string, optional (default=&#39;avg_nn&#39;)</span>
<span class="sd">        Type of scaling used in the atom structure scaling. See :py:mod:`ai4materials.utils.utils_crystals.scale_structure`</span>
<span class="sd">        for more details.</span>

<span class="sd">    atoms_scaling_cutoffs: list of float, optional (default=[4.0, 5.0, 7.0, 9.0, 11.0, 12.0])</span>
<span class="sd">        List of cutoffs to be used in the determination of the lengthscale of the system to be used in</span>
<span class="sd">        :py:mod:`ai4materials.utils.utils_crystals.scale_structure`.</span>

<span class="sd">    use_mask: bool, optional (default=True)</span>
<span class="sd">        If `True`, a mask such that only (`mask_r_min` &lt; points &lt; `mask_r_max`) are kept in the calculated</span>
<span class="sd">        diffraction pattern. This is done because the central peak in diffraction is very intense</span>
<span class="sd">        but does not carry useful information regarding the atomic structure.</span>

<span class="sd">    mask_r_min: float, optional (default=5)</span>
<span class="sd">        The intensity of the points in the diffraction pattern with a radius smaller than `mask_r_min` are set to zero.</span>

<span class="sd">    mask_r_max: float, optional (default=30)</span>
<span class="sd">        The intensity of the points in the diffraction pattern with a radius larger than `mask_r_max` are set to zero.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This descriptor was introduced in the following article:</span>

<span class="sd">        A. Ziletti, D. Kumar, M. Scheffler, and L. M. Ghiringhelli, &quot;Insightful classification of crystal structures</span>
<span class="sd">        using deep learning&quot;, Nature Communications 9, 2775, (2018) [`Link to article &lt;https://www.nature.com/articles/s41467-018-05169-6&gt;`_]</span>

<span class="sd">        Please cite this manuscript if you find this descriptor useful in your work.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        To calculate the diffraction pattern we use the open source software Condor.</span>
<span class="sd">        See the Condor webpage for more details: http://condor.readthedocs.io/en/.</span>

<span class="sd">    .. codeauthor:: Angelo Ziletti &lt;angelo.ziletti@gmail.com&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_detector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atoms_scaling</span><span class="o">=</span><span class="s1">&#39;avg_nn&#39;</span><span class="p">,</span>
                 <span class="n">atoms_scaling_cutoffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_r_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_r_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Diffraction2D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_source</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="mf">5.0E-12</span><span class="p">,</span> <span class="s1">&#39;pulse_energy&#39;</span><span class="p">:</span> <span class="mf">1E-6</span><span class="p">,</span> <span class="s1">&#39;focus_diameter&#39;</span><span class="p">:</span> <span class="mf">1E-6</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">param_detector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_detector</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;pixel_size&#39;</span><span class="p">:</span> <span class="mf">4E-4</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">atoms_scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atoms_scaling</span> <span class="o">=</span> <span class="s1">&#39;avg_distance_nn&#39;</span>

        <span class="k">if</span> <span class="n">atoms_scaling_cutoffs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atoms_scaling_cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">desc_angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc_angles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">],</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">45.</span><span class="p">]}</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;param_source&quot;</span><span class="p">:</span> <span class="n">param_source</span><span class="p">,</span> <span class="s2">&quot;param_detector&quot;</span><span class="p">:</span> <span class="n">param_detector</span><span class="p">,</span> <span class="s2">&quot;use_mask&quot;</span><span class="p">:</span> <span class="n">use_mask</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_scaling</span> <span class="o">=</span> <span class="n">atoms_scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_scaling_cutoffs</span> <span class="o">=</span> <span class="n">atoms_scaling_cutoffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span> <span class="o">=</span> <span class="n">param_detector</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_py</span> <span class="o">=</span> <span class="n">param_detector</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_source</span> <span class="o">=</span> <span class="n">param_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_detector</span> <span class="o">=</span> <span class="n">param_detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mask</span> <span class="o">=</span> <span class="n">use_mask</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_py</span><span class="p">,</span> <span class="s2">&quot;Images needs to have equal width and height while we have </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_py</span><span class="p">)</span>

        <span class="c1"># add derived parameters</span>
        <span class="k">if</span> <span class="n">mask_r_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_r_min</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">/</span> <span class="mf">32.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span>

        <span class="k">if</span> <span class="n">mask_r_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_r_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span> <span class="o">/</span> <span class="mf">32.</span>

        <span class="n">rot_matrices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rot_matrices_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">desc_angle</span> <span class="ow">in</span> <span class="n">desc_angles</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]:</span>
            <span class="n">rot_matrices_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot_mat_x</span><span class="p">(</span><span class="n">desc_angle</span><span class="p">))</span>
        <span class="n">rot_matrices</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_matrices_x</span>

        <span class="n">rot_matrices_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">desc_angle</span> <span class="ow">in</span> <span class="n">desc_angles</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]:</span>
            <span class="n">rot_matrices_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot_mat_y</span><span class="p">(</span><span class="n">desc_angle</span><span class="p">))</span>
        <span class="n">rot_matrices</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_matrices_y</span>

        <span class="n">rot_matrices_z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">desc_angle</span> <span class="ow">in</span> <span class="n">desc_angles</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]:</span>
            <span class="n">rot_matrices_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot_mat_z</span><span class="p">(</span><span class="n">desc_angle</span><span class="p">))</span>
        <span class="n">rot_matrices</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_matrices_z</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_min</span> <span class="o">=</span> <span class="n">mask_r_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_max</span> <span class="o">=</span> <span class="n">mask_r_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_matrices</span> <span class="o">=</span> <span class="n">rot_matrices</span>

<div class="viewcode-block" id="Diffraction2D.calculate"><a class="viewcode-back" href="../../../ai4materials.descriptors.diffraction2d.html#ai4materials.descriptors.diffraction2d.Diffraction2D.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the descriptor for the given ASE structure.</span>

<span class="sd">        Parameters:</span>

<span class="sd">        structure: `ase.Atoms` object</span>
<span class="sd">            Atomic structure.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">atoms</span> <span class="o">=</span> <span class="n">scale_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">scaling_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_scaling</span><span class="p">,</span>
                                <span class="n">atoms_scaling_cutoffs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_scaling_cutoffs</span><span class="p">)</span>

        <span class="c1"># Source</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">condor</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">param_source</span><span class="p">)</span>

        <span class="c1"># Detector</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">condor</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">param_detector</span><span class="p">)</span>

        <span class="c1"># Atoms</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomic_number</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">atomic_number</span> <span class="ow">in</span> <span class="n">atomic_numbers</span><span class="p">]</span>

        <span class="c1"># convert Angstrom to m (CONDOR uses meters)</span>
        <span class="n">atomic_positions</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1E-10</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mf">1E-10</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mf">1E-10</span><span class="p">],</span> <span class="n">atoms</span><span class="p">)</span>

        <span class="n">intensity_rgb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rs_rgb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ph_rgb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">real_space</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="n">rot_matrices</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rot_matrices</span><span class="p">):</span>
            <span class="c1"># loop over channels</span>
            <span class="n">intensity_channel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rs_channel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ph_channel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rot_matrix</span> <span class="ow">in</span> <span class="n">rot_matrices</span><span class="p">:</span>
                <span class="c1"># loop over the rotation matrices in a given channel</span>
                <span class="c1"># and sum the intensities in the same channel</span>
                <span class="n">quaternion</span> <span class="o">=</span> <span class="n">condor</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">quat_from_rotmx</span><span class="p">(</span><span class="n">rot_matrix</span><span class="p">)</span>
                <span class="n">rotation_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">quaternion</span><span class="p">])</span>
                <span class="n">rotation_formalism</span> <span class="o">=</span> <span class="s1">&#39;quaternion&#39;</span>
                <span class="n">rotation_mode</span> <span class="o">=</span> <span class="s1">&#39;intrinsic&#39;</span>

                <span class="n">par</span> <span class="o">=</span> <span class="n">condor</span><span class="o">.</span><span class="n">ParticleAtoms</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="o">=</span><span class="n">atomic_numbers</span><span class="p">,</span> <span class="n">atomic_positions</span><span class="o">=</span><span class="n">atomic_positions</span><span class="p">,</span>
                                           <span class="n">rotation_values</span><span class="o">=</span><span class="n">rotation_values</span><span class="p">,</span> <span class="n">rotation_formalism</span><span class="o">=</span><span class="n">rotation_formalism</span><span class="p">,</span>
                                           <span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;particle_atoms&#39;</span>
                <span class="n">condor_exp</span> <span class="o">=</span> <span class="n">condor</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">par</span><span class="p">},</span> <span class="n">det</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">condor_exp</span><span class="o">.</span><span class="n">propagate</span><span class="p">()</span>

                <span class="c1"># retrieve results</span>
                <span class="n">real_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;entry_1&quot;</span><span class="p">][</span><span class="s2">&quot;data_1&quot;</span><span class="p">][</span><span class="s2">&quot;data_fourier&quot;</span><span class="p">])))</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;entry_1&quot;</span><span class="p">][</span><span class="s2">&quot;data_1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="n">fourier_space</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;entry_1&quot;</span><span class="p">][</span><span class="s2">&quot;data_1&quot;</span><span class="p">][</span><span class="s2">&quot;data_fourier&quot;</span><span class="p">]</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">fourier_space</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_mask</span><span class="p">:</span>
                    <span class="c1"># set to zero values outside a ring-like mask</span>
                    <span class="n">xc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">yc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_py</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_px</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">:</span><span class="n">n</span> <span class="o">-</span> <span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">:</span><span class="n">n</span> <span class="o">-</span> <span class="n">b</span><span class="p">]</span>

                    <span class="n">mask_int</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_min</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_min</span>
                    <span class="n">mask_ext</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_max</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_r_max</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_px</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_py</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">mask_int</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                                <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="n">mask_ext</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                                <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">intensity_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
                <span class="n">rs_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">real_space</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
                <span class="n">ph_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>

            <span class="c1"># first sum the angles within the channel, then normalize</span>
            <span class="n">intensity_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity_channel</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rs_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rs_channel</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ph_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph_channel</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># append normalized data from different channels</span>
            <span class="c1"># and divide by the angles per channel</span>
            <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity_channel</span><span class="p">)</span>
            <span class="n">rs_rgb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs_channel</span><span class="p">)</span>
            <span class="n">ph_rgb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph_channel</span><span class="p">)</span>

        <span class="n">intensity_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity_rgb</span><span class="p">)</span>
        <span class="n">intensity_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_rgb</span> <span class="o">-</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">intensity_rgb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">rs8</span> <span class="o">=</span> <span class="p">(((</span><span class="n">real_space</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">real_space</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">real_space</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">real_space</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">ph8</span> <span class="o">=</span> <span class="p">(((</span><span class="n">phases</span> <span class="o">-</span> <span class="n">phases</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">phases</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">phases</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># reshape to have nb of color channels last</span>
        <span class="n">intensity_rgb</span> <span class="o">=</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># add results in ASE structure info</span>
        <span class="n">descriptor_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">descriptor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">descriptor_info</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">diffraction_2d_intensity</span><span class="o">=</span><span class="n">intensity_rgb</span><span class="p">,</span> <span class="n">diffraction_2d_real_space</span><span class="o">=</span><span class="n">rs8</span><span class="p">,</span>
                               <span class="n">diffraction_2d_phase</span><span class="o">=</span><span class="n">ph8</span><span class="p">)</span>

        <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">descriptor_data</span>

        <span class="k">return</span> <span class="n">structure</span></div>

<div class="viewcode-block" id="Diffraction2D.write"><a class="viewcode-back" href="../../../ai4materials.descriptors.diffraction2d.html#ai4materials.descriptors.diffraction2d.Diffraction2D.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">tar</span><span class="p">,</span> <span class="n">op_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">write_intensity_npy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_intensity_png</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_rspace_png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">write_phase_png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_geo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">format_geometry</span><span class="o">=</span><span class="s1">&#39;aims&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the descriptor to file.</span>

<span class="sd">        Parameters:</span>

<span class="sd">        structure: `ase.Atoms` obejct</span>
<span class="sd">            Atomic structure.</span>

<span class="sd">        tar: TarFile object</span>
<span class="sd">            TarFile archive where the descriptor is added. This is created internally with `tarfile.open`.</span>

<span class="sd">        op_id: int, optional (default=0)</span>
<span class="sd">            Number of the applied operation to the descriptor. At present always set to zero in the code.</span>

<span class="sd">        write_intensity_png: bool, optional (default=`True`)</span>
<span class="sd">            If `True`, write to file diffraction intensities as numpy arrays.</span>

<span class="sd">        write_rspace_png: bool, optional (default=`False`)</span>
<span class="sd">            If `True`, write to file a png file with the real space structure for which the diffraction pattern</span>
<span class="sd">            is calculated.</span>

<span class="sd">        write_phase_png: bool, optional (default=`False`)</span>
<span class="sd">            If `True`, write to file a png file with the phases of the diffraction pattern.</span>

<span class="sd">        write_geo: bool, optional (default=`True`)</span>
<span class="sd">            If `True`, write a coordinate file of the structure for which the diffraction pattern is calculated.</span>

<span class="sd">        format_geometry: string, optional (default=`aims`)</span>
<span class="sd">            Output format of the geometry file. All ASE valid output formats are accepted.</span>
<span class="sd">            For a complete list see: https://wiki.fysik.dtu.dk/ase/ase/io/io.html</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_descriptor_consistent</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Descriptor not consistent. Aborting.&#39;</span><span class="p">)</span>

        <span class="n">desc_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="s1">&#39;desc_folder&#39;</span><span class="p">]</span>
        <span class="n">descriptor_info</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">][</span><span class="s1">&#39;descriptor_info&#39;</span><span class="p">]</span>

        <span class="n">intensity_rgb</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">][</span><span class="s1">&#39;diffraction_2d_intensity&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">write_intensity_npy</span><span class="p">:</span>
            <span class="n">intensity_filename_npy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_folder</span><span class="p">,</span>
                                                                                   <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span>
                                                                                       <span class="s1">&#39;diffraction_2d_intensity&#39;</span><span class="p">][</span>
                                                                                       <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">intensity_filename_npy</span><span class="p">,</span> <span class="n">intensity_rgb</span><span class="p">)</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_intensity_filename_npy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_filename_npy</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_intensity_filename_npy&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">write_intensity_png</span><span class="p">:</span>
            <span class="n">intensity_filename_png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_folder</span><span class="p">,</span>
                                                                                   <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span>
                                                                                       <span class="s1">&#39;diffraction_2d_intensity_image&#39;</span><span class="p">][</span>
                                                                                       <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>
            <span class="n">rgb_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

            <span class="n">current_img</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intensity_rgb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">ix_ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_img</span><span class="p">)):</span>
                <span class="n">rgb_array</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ix_ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_img</span><span class="p">[</span><span class="n">ix_ch</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">intensity_filename_png</span><span class="p">)</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_intensity_filename_png&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_filename_png</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_intensity_filename_png&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">write_rspace_png</span><span class="p">:</span>
            <span class="n">real_space</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">][</span><span class="s1">&#39;diffraction_2d_real_space&#39;</span><span class="p">]</span>
            <span class="n">real_space_filename_png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_folder</span><span class="p">,</span>
                                                                                    <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;real_space&#39;</span><span class="p">][</span>
                                                                                        <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">real_space</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">real_space_filename_png</span><span class="p">)</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_real_space_filename_png&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_space_filename_png</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_real_space_filename_png&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">write_phase_png</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">][</span><span class="s1">&#39;diffraction_2d_phase&#39;</span><span class="p">]</span>
            <span class="n">phase_filename_png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_folder</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span>
                                                                                   <span class="s1">&#39;diffraction_2d_phase&#39;</span><span class="p">][</span>
                                                                                   <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">phase_filename_png</span><span class="p">)</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diffraction_2d_phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_filename_png</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diffraction_2d_phase&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">write_geo</span><span class="p">:</span>
            <span class="c1"># to have the file accessible by the Beaker notebook image we need to put them</span>
            <span class="c1"># in a special folder (&#39;/user/tmp&#39;)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;isBeaker&#39;</span><span class="p">]:</span>
                <span class="c1"># only for Beaker Notebook</span>
                <span class="n">coord_filename_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/user/tmp/&#39;</span><span class="p">,</span>
                                                                                  <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span>
                                                                                      <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coord_filename_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_folder</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">desc_metadata</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span>
                                                                                      <span class="s1">&#39;diffraction_2d_coordinates&#39;</span><span class="p">][</span>
                                                                                      <span class="s1">&#39;file_ending&#39;</span><span class="p">])))</span>

            <span class="n">structure</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">coord_filename_in</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">format_geometry</span><span class="p">)</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_coord_filename_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_filename_in</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;diff_2d_coord_filename_in&#39;</span><span class="p">])</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Angelo Ziletti.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>